<head>
    <%- include('../partials/user/header') %>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âL√âGANCE - My Profile</title>
    <link rel="stylesheet" href="/user/profile.css">
    <!-- Cropper.js -->
    <link href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
</head>
<body>
    
    <!-- Profile Header Section -->
    <div class="profile-header">
        <div class="profile-hero-content">
            <div class="profile-avatar-wrapper">
                <div class="profile-avatar" id="profileAvatar">
                    <% if (user.profileImage) { %>
                        <img src="<%= user.profileImage %>" alt="Profile Photo" id="avatarPreview">
                    <% } else { %>
                        <span id="avatarInitials">
                            <%= user.name ? user.name.split(' ').map(n => n[0].toUpperCase()).join('') : 'U' %>
                        </span>
                    <% } %>
                </div>
                <label for="avatarInput" class="avatar-edit" title="Upload photo">üì∑</label>
                <input type="file" id="avatarInput" accept="image/*" style="display:none;">
            </div>
            
            <h1 class="profile-name"><%= user.name %></h1>
            <p class="profile-email"><%= user.email %></p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="profile-container">
        <div class="profile-grid">
            
            <!-- Sidebar Navigation -->
            <aside class="profile-sidebar">
                <nav>
                    <ul class="sidebar-nav">
                        <li><a href="#profile" class="active"><span>üë§</span> <span>My Profile</span></a></li>
                        <li><a href="/my-orders"><span>üì¶</span> <span>My Orders</span></a></li>

                        <li><a href="#wishlist"><span>‚ô°</span> <span>Wishlist</span></a></li>
                        <li><a href="/addresses"><span>üìç</span> <span>Addresses</span></a></li>
                        <li><a href="#settings"><span>‚öôÔ∏è</span> <span>Settings</span></a></li>
                    </ul>
                </nav>
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <div class="stat-value">12</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">8</div>
                        <div class="stat-label">Wishlist Items</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">‚Çπ45K</div>
                        <div class="stat-label"></div>
                    </div>
                </div>
                
                <form action="/logout" method="POST">
                    <button class="btn-logout" type="submit">
                        <span>üö™</span> <span>Logout</span>
                    </button>
                </form>
            </aside>
           
            <!-- Main Content Area -->
            <main class="profile-main" id="profile">
                
                <!-- Personal Information Section -->
                <section class="profile-section">
                    <div class="info-header">
                        <h2 class="section-title">Personal Information</h2>
                        <button class="btn-edit-profile" id="openEditModal">
                            <span>‚úèÔ∏è</span> <span>Edit Profile</span>
                        </button>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Full Name</span>
                            <span class="info-value"><%= user.name %></span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Email Address</span>
                            <span class="info-value"><%= user.email %></span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Phone Number</span>
                            <span class="info-value"><%= user.phone || 'Not provided' %></span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Member Since</span>
                            <span class="info-value"><%= user.createdOn %></span>
                        </div>
                    </div>
                </section>

                <!-- Security Section -->
                <section class="profile-section security-section">
                    <h3 class="subsection-title">Security</h3>
                    <div class="security-item">
                        <div class="security-left">
                            <div class="info-label">Password</div>
                            <div class="info-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        </div>
                        <button class="btn-change" id="changePasswordBtn">
                            <span>üîí</span> <span>Change</span>
                        </button>
                    </div>
                </section>
                
                <!-- Addresses Section -->
                <!-- <section class="profile-section addresses-section">
                    <div class="info-header">
                        <h2 class="section-title">My Addresses</h2>
                        <button class="btn-edit-profile" id="openAddressModalBtn">
                            <span>üìç</span> <span>Add New Address</span>
                        </button>
                    </div>
                    <div id="addressesContainer"></div>
                </section> -->
                
            </main>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal" aria-label="Close modal">√ó</button>
            
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <p class="modal-subtitle">Update your personal information</p>
            </div>
                        
                    <div class="modal-avatar">
                <% if (user && user.name) { %>
                    <%= user.name
                        .trim()
                        .split(/\s+/)
                        .map(n => n.charAt(0).toUpperCase())
                        .join('') %>
                <% } else { %>
                    U
                <% } %>
            </div>

            
            <form id="editProfileForm">
                <div class="modal-form-grid">
                    <div class="modal-form-group">
                        <label class="modal-form-label" for="editName">Full Name</label>
                        <input type="text" id="editName" name="name" class="modal-form-input" value="<%= user.name %>" placeholder="Enter full name" required>
                        <div class="error-message"></div>
                    </div>

                    <div class="modal-form-group">
                        <label class="modal-form-label" for="editEmail">Email Address</label>
                         <input type="email" 
                                            id="editEmail"
                                            name="email"
                                            class="modal-form-input"
                                            value="<%= user.email %>"
                                           data-original="<%= user.email %>"

                                            placeholder="Enter email"
                                            required>
                 

                        <div class="error-message"></div>
                    </div>

                    <div class="modal-form-group full-width">
                        <label class="modal-form-label" for="editPhone">Phone Number</label>
                        <input type="tel" id="editPhone" name="phone" class="modal-form-input" value="<%= user.phone || '' %>" placeholder="Enter phone number">
                        <div class="error-message"></div>
                    </div>
                </div>
                
                <div class="modal-form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal-overlay" id="otpModal">
        <div class="modal-content otp-modal-content">
            <button class="modal-close" id="closeOtpModal" aria-label="Close OTP modal">√ó</button>
            
            <div class="modal-header">
                <h2 class="modal-title">Verify OTP</h2>
                <p class="modal-subtitle">Enter the verification code sent to your email</p>
            </div>
            
            <div id="otpMessage" class="message" style="display: none;"></div>
            
            <form id="otpForm">
                <div class="otp-input-group">
                    <input type="text" class="otp-input" maxlength="1" data-index="0" aria-label="OTP digit 1">
                    <input type="text" class="otp-input" maxlength="1" data-index="1" aria-label="OTP digit 2">
                    <input type="text" class="otp-input" maxlength="1" data-index="2" aria-label="OTP digit 3">
                    <input type="text" class="otp-input" maxlength="1" data-index="3" aria-label="OTP digit 4">
                    <input type="text" class="otp-input" maxlength="1" data-index="4" aria-label="OTP digit 5">
                    <input type="text" class="otp-input" maxlength="1" data-index="5" aria-label="OTP digit 6">
                </div>
                
                <div class="otp-timer">
                    <span id="timer">02:00</span>
                </div>
                
                <div class="otp-actions">
                    <button type="button" class="btn-resend" id="resendOtp" disabled>Resend OTP</button>
                    <button type="submit" class="btn btn-primary">Verify</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="password-modal" id="passwordModal">
        <h3>Change Password</h3>
        <form id="passwordChangeForm">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" required minlength="6" placeholder="Enter new password">
                <div class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" placeholder="Confirm new password">
                <div class="error-message"></div>
            </div>
            <div class="password-modal-actions">
                <button type="button" class="btn-cancel-password" id="cancelPassword">Cancel</button>
                <button type="submit" class="btn-submit-password">Update Password</button>
            </div>
        </form>
    </div>
 
    <!-- Address Modal -->
    <div id="addressModalBox" class="address-modal">
        <div class="address-modal-content">
            <button class="address-modal-close" id="closeAddressModal" aria-label="Close address modal">&times;</button>
            
            <h2 class="address-modal-title">Add New Address</h2>
            <p class="address-modal-subtitle">Please fill in your address details below</p>
            
            <form id="addressForm" action="/user/add-address">
                <div class="address-form-group">
                    <label for="addressType">Address Type</label>
                    <select id="addressType" name="addressType" required>
                        <option value="">Select Type</option>
                        <option value="Home">üè° Home</option>
                        <option value="Work">üè¢ Work</option>
                        <option value="Other">üìç Other</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" placeholder="Enter full name" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" placeholder="Enter city" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="landMark">Landmark</label>
                    <input type="text" id="landMark" name="landMark" placeholder="Enter landmark" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="state">State</label>
                    <input type="text" id="state" name="state" placeholder="Enter state" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="pincode">Pincode</label>
                    <input type="number" id="pincode" name="pincode" placeholder="Enter pincode" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" name="phone" placeholder="Enter phone number" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="address-form-group">
                    <label for="altphone">Alternate Phone</label>
                    <input type="tel" id="altphone" name="altphone" placeholder="Enter alternate phone (optional)">
                    <div class="error-message"></div>
                </div>
                
                <button type="submit" class="btn-save-address">
                    <span>üíæ</span> <span>Save Address</span>
                </button>
            </form>
        </div>
    </div> 

    <!-- Profile Image Crop Modal -->
    <div id="cropModal" class="address-modal" style="display:none;">
        <div class="address-modal-content" style="max-width:550px; text-align:center;">
            <button id="closeCropModal" class="address-modal-close" aria-label="Close crop modal">&times;</button>
            
            <h2 class="address-modal-title">Adjust Your Profile Photo</h2>
            <p class="address-modal-subtitle">Crop and position your image before saving</p>
            
            <div style="width:100%; max-height:400px; overflow:hidden; margin: 20px 0;">
                <img id="cropImagePreview" style="max-width:100%; display:block; margin:auto;" alt="Crop preview"/>
            </div>
            
            <div style="margin-top:25px; display:flex; justify-content:center; gap:15px;">
                <button id="cancelCrop" class="btn-cancel-password">
                    <span></span> <span>Cancel</span>
                </button>
                <button id="saveCroppedImage" class="btn-save-address">
                    <span>üíæ</span> <span>Save Photo</span>
                </button>
            </div>
        </div>
    </div>

</body>

                <script>
                    

    const nameInput = document.getElementById("editName");
    const emailInput = document.getElementById("editEmail");
    const phoneInput = document.getElementById("editPhone");
    const form = document.getElementById("editProfileForm");
                    // === GLOBAL VARIABLES ‚Äî KEEP ONLY THIS ===
let updatedData = {};
let isEmailChange = false;
let isPasswordChange = false;
let currentEmail = "";
let otpType = "";
let otpTimer;
let timeLeft = 120;
document.addEventListener('DOMContentLoaded', function() {
    emailInput.dataset.original = emailInput.value.trim();

    // Handle sidebar navigation
    const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
    
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Remove active class from all links
            sidebarLinks.forEach(l => l.classList.remove('active'));
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Handle internal anchor links
            const href = this.getAttribute('href');
            if (href.startsWith('#')) {
                e.preventDefault();
                const targetId = href.substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });

});



document.addEventListener("DOMContentLoaded", function () {


    // Show error
    function setError(input, message) {
        const group = input.closest(".modal-form-group");
        const errorDiv = group.querySelector(".error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        input.classList.add("input-error");
    }

    // Remove error
    function clearError(input) {
        const group = input.closest(".modal-form-group");
        const errorDiv = group.querySelector(".error-message");
        errorDiv.textContent = "";
        errorDiv.style.display = "none";
        input.classList.remove("input-error");
    }

    /* ============================
       REAL-TIME VALIDATION
       ============================ */

    // Name
    nameInput.addEventListener("input", () => {
        const value = nameInput.value.trim();
        const valid = /^[A-Za-z\s]{3,}$/.test(value);

        valid ? clearError(nameInput)
              : setError(nameInput, "Name must be at least 3 letters.");
    });

    // Email
    emailInput.addEventListener("input", () => {
        const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());

        valid ? clearError(emailInput)
              : setError(emailInput, "Invalid email format.");
    });

    // Phone
    phoneInput.addEventListener("input", () => {
        const value = phoneInput.value.trim();

        if (value === "") return clearError(phoneInput);

        const valid = /^[7-9]\d{6,14}$/.test(value);

        valid ? clearError(phoneInput)
              : setError(phoneInput, "Phone must start with 7/8/9 and be 7‚Äì15 digits.");
    });

    

});



                 document.getElementById('addressForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // Remove previous errors
  document.querySelectorAll('.error-message').forEach(msg => {
    msg.textContent = '';
    msg.style.display = 'none';
  });
  document.querySelectorAll('input, select').forEach(f => f.classList.remove('error'));

  let valid = true;

  // Field references
  const addressType = this.elements["addressType"];
  const name = this.elements["name"];
  const city = this.elements["city"];
  const landMark = this.elements["landMark"];
  const state = this.elements["state"];
  const pincode = this.elements["pincode"];
  const phone = this.elements["phone"];
  const altphone = this.elements["altphone"];

  // Patterns
  const namePattern = /^[A-Za-z\s]{3,}$/;
  const pincodePattern = /^\d{6}$/;
  const phonePattern = /^[6-9]\d{9}$/;

  // Validate addressType
  if (!addressType.value.trim()) {
    addressType.classList.add('error');
    addressType.parentElement.querySelector('.error-message').textContent = "Select address type.";
    addressType.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate name
  if (!namePattern.test(name.value.trim())) {
    name.classList.add('error');
    name.parentElement.querySelector('.error-message').textContent = "Enter full name (min 3 letters).";
    name.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate city
  if (!city.value.trim()) {
    city.classList.add('error');
    city.parentElement.querySelector('.error-message').textContent = "City is required.";
    city.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate state
  if (!state.value.trim()) {
    state.classList.add('error');
    state.parentElement.querySelector('.error-message').textContent = "State is required.";
    state.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate pincode
  if (!pincodePattern.test(pincode.value.trim())) {
    pincode.classList.add('error');
    pincode.parentElement.querySelector('.error-message').textContent = "Enter 6 digit pincode.";
    pincode.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate phone
  if (!phonePattern.test(phone.value.trim())) {
    phone.classList.add('error');
    phone.parentElement.querySelector('.error-message').textContent = "Enter valid phone (10 digits, starts with 6-9).";
    phone.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  // Validate altphone only if not empty
  if (altphone.value && !phonePattern.test(altphone.value.trim())) {
    altphone.classList.add('error');
    altphone.parentElement.querySelector('.error-message').textContent = "Alt phone must be 10 digits, starts with 6-9.";
    altphone.parentElement.querySelector('.error-message').style.display = "block";
    valid = false;
  }

  if (valid) {
    this.submit(); // Or AJAX submit if you prefer
  }
});




                // Modal functionality
                const openModalBtn = document.getElementById('openEditModal');
                const closeModalBtn = document.getElementById('closeModal');
                const cancelEditBtn = document.getElementById('cancelEdit');
                const modal = document.getElementById('editProfileModal');
                const editForm = document.getElementById('editProfileForm');
                
                // OTP Modal elements
                const otpModal = document.getElementById('otpModal');
                const closeOtpModalBtn = document.getElementById('closeOtpModal');
                const otpForm = document.getElementById('otpForm');
                const otpInputs = document.querySelectorAll('.otp-input');
                const resendOtpBtn = document.getElementById('resendOtp');
                const timerElement = document.getElementById('timer');
                const otpMessage = document.getElementById('otpMessage');
                const changePasswordBtn = document.getElementById('changePasswordBtn');
                
                // Password Modal elements
                const passwordModal = document.getElementById('passwordModal');
                const cancelPasswordBtn = document.getElementById('cancelPassword');
                const passwordChangeForm = document.getElementById('passwordChangeForm');

            
                
             
                
                // Initialize
                document.addEventListener('DOMContentLoaded', () => {
                    // Add click effects to buttons
                    document.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', function(e) {
                            const ripple = document.createElement('span');
                            const rect = this.getBoundingClientRect();
                            const size = Math.max(rect.width, rect.height);
                            const x = e.clientX - rect.left - size / 2;
                            const y = e.clientY - rect.top - size / 2;
                            
                            ripple.style.cssText = `
                                position: absolute;
                                border-radius: 50%;
                                background: rgba(255, 255, 255, 0.5);
                                transform: scale(0);
                                animation: ripple 0.6s linear;
                                width: ${size}px;
                                height: ${size}px;
                                left: ${x}px;
                                top: ${y}px;
                                pointer-events: none;
                            `;
                            
                            this.appendChild(ripple);
                            
                            setTimeout(() => {
                                ripple.remove();
                            }, 600);
                        });
                    });
                });
                
                // Ripple animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes ripple {
                        to {
                            transform: scale(4);
                            opacity: 0;
                        }
                    }
                    button {
                        position: relative;
                        overflow: hidden;
                    }
                `;
                document.head.appendChild(style);
                
             openModalBtn.addEventListener('click', () => {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

   
});

                
                function closeModal() {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
                
                closeModalBtn.addEventListener('click', closeModal);
                cancelEditBtn.addEventListener('click', closeModal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // Handle profile form submission

                
         editForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const originalEmail = emailInput.dataset.original;
    const newEmail = emailInput.value.trim();

    updatedData = {
        name: nameInput.value.trim(),
        email: newEmail,
        phone: phoneInput.value.trim()
    };

    // ONLY email changed
    if (newEmail !== originalEmail) {

        isEmailChange = true;
        otpType = 'email';
        currentEmail = newEmail;

        showOtpModal();
        sendOtp(newEmail, 'email');
        return;  // IMPORTANT!
    }

    // No email change
    updateProfile(updatedData);
});


                
            
             changePasswordBtn.addEventListener('click', async () => {
             isPasswordChange = true;
             otpType = 'password';
            currentEmail = '<%= user.email %>';

          showOtpModal();

  
          sendOtp(currentEmail, 'password');
        });

                
                // Show OTP modal
                function showOtpModal() {
                    closeModal();
                    otpModal.classList.add('active');
                    startOtpTimer();
                    otpInputs[0].focus();
                    
                    // Update modal title based on type
                    const modalTitle = document.querySelector('#otpModal .modal-title');
                    const modalSubtitle = document.querySelector('#otpModal .modal-subtitle');
                    
                    if (otpType === 'email') {
                        modalTitle.textContent = 'Verify Email Change';
                        modalSubtitle.textContent = 'Enter OTP sent to your new email address';
                    } else {
                        modalTitle.textContent = 'Verify Password Change';
                        modalSubtitle.textContent = 'Enter OTP sent to your email address';
                    }
                }
                
                // Close OTP modal
                function closeOtpModal() {
                    otpModal.classList.remove('active');
                    resetOtpForm();
                    clearInterval(otpTimer);
                    timeLeft = 120;
                    updateTimerDisplay();
                    isEmailChange = false;
                    isPasswordChange = false;
                    currentEmail = '';
                    otpType = '';
                }
                
                closeOtpModalBtn.addEventListener('click', closeOtpModal);
                
                // Handle OTP input navigation
                otpInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        const value = e.target.value;
                        // Only allow numbers
                        if (!/^\d*$/.test(value)) {
                            e.target.value = value.replace(/\D/g, '');
                            return;
                        }
                        
                        if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                        
                        // Auto-submit when all fields are filled
                        if (index === otpInputs.length - 1 && value.length === 1) {
                            const allFilled = Array.from(otpInputs).every(input => input.value.length === 1);
                            if (allFilled) {
                                setTimeout(() => otpForm.dispatchEvent(new Event('submit')), 100);
                            }
                        }
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace') {
                            if (!e.target.value && index > 0) {
                                otpInputs[index - 1].focus();
                            }
                        }
                        
                        // Allow navigation with arrow keys
                        if (e.key === 'ArrowLeft' && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                        if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    });
                    
                    // Handle paste event for OTP
                    input.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const pasteData = e.clipboardData.getData('text').slice(0, 6);
                        if (/^\d+$/.test(pasteData)) {
                            pasteData.split('').forEach((char, i) => {
                                if (otpInputs[i]) {
                                    otpInputs[i].value = char;
                                }
                            });
                            otpInputs[Math.min(5, pasteData.length - 1)].focus();
                        }
                    });
                });
                
                // Handle OTP form submission
                otpForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const otp = Array.from(otpInputs).map(input => input.value).join('');
                    
                    if (otp.length !== 6) {
                        showMessage('Please enter the complete 6-digit OTP', 'error');
                        return;
                    }
                    
                    showMessage('Verifying OTP...', 'success');
                    
                    const isValid = await verifyOtp(otp, currentEmail);
                    
                    if (isValid) {
                        showMessage('OTP verified successfully!', 'success');
                        
                        setTimeout(() => {
                            if (otpType === 'email') {
                                updatedData.email = currentEmail;  
                                updateProfile(updatedData);
                            } else if (otpType === 'password') {
                                showPasswordChangeForm();
                            }
                            closeOtpModal();
                        }, 1000);
                    }
                });
                
                // Resend OTP
                resendOtpBtn.addEventListener('click', async () => {
                    await sendOtp(currentEmail, otpType);
                    resetOtpTimer();
                });
                
                // OTP timer functions
                function startOtpTimer() {
                    clearInterval(otpTimer);
                    timeLeft = 80;
                    updateTimerDisplay();
                    resendOtpBtn.disabled = true;
                    resendOtpBtn.style.opacity = '0.5';
                    
                    otpTimer = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();
                        
                        if (timeLeft <= 0) {
                            clearInterval(otpTimer);
                            resendOtpBtn.disabled = false;
                            resendOtpBtn.style.opacity = '1';
                            resendOtpBtn.textContent = 'Resend OTP';
                        }
                    }, 1000);
                }
                
                function resetOtpTimer() {
                    clearInterval(otpTimer);
                    startOtpTimer();
                }
                
                function updateTimerDisplay() {
                    const minutes = Math.floor(timeLeft / 40);
                    const seconds = timeLeft % 40;
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    resendOtpBtn.textContent = `Resend OTP (${timeLeft}s)`;
                }
                
                function resetOtpForm() {
                    otpInputs.forEach(input => input.value = '');
                    otpMessage.style.display = 'none';
                }
                
                function showMessage(text, type) {
                    otpMessage.textContent = text;
                    otpMessage.className = `message ${type}`;
                    otpMessage.style.display = 'block';
                    
                    // Auto-hide success messages after 5 seconds
                    if (type === 'success' && !text.includes('Verifying') && !text.includes('Sending')) {
                        setTimeout(() => {
                            otpMessage.style.display = 'none';
                        }, 5000);
                    }
                }
                
                // Show password change form (using pre-rendered modal)
                function showPasswordChangeForm() {
                    passwordModal.classList.add('active');
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                }
                
                // Close password modal
                function closePasswordModal() {
                    passwordModal.classList.remove('active');
                }
                
                cancelPasswordBtn.addEventListener('click', closePasswordModal);
                
                // Handle password form submission
                passwordChangeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword !== confirmPassword) {
                        alert('Passwords do not match!');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters long!');
                        return;
                    }
                    
                    await updatePassword(newPassword);
                    closePasswordModal();
                });
                
                // Close password modal when clicking outside
                passwordModal.addEventListener('click', (e) => {
                    if (e.target === passwordModal) {
                        closePasswordModal();
                    }
                });
                
                // API functions
                async function sendOtp(email, type) {
                    try {
                        showMessage('Sending OTP...', 'success');
                        
                        const response = await fetch('/send-otp', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email, type })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage('OTP sent successfully! Check your email.', 'success');
                        } else {
                            showMessage(data.message || 'Failed to send OTP', 'error');
                        }
                    } catch (error) {
                        console.error('Error sending OTP:', error);
                        showMessage('Failed to send OTP. Please try again.', 'error');
                    }
                }
                
                async function verifyOtp(otp, email) {
                    try {
                        const response = await fetch('/verify-otp', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ otp, email })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            otpType = data.type || otpType;
                            return true;
                        } else {
                            showMessage(data.message || 'Invalid OTP', 'error');
                            return false;
                        }
                    } catch (error) {
                        console.error('Error verifying OTP:', error);
                        showMessage('Failed to verify OTP. Please try again.', 'error');
                        return false;
                    }
                }
                



                
                async function updateProfile(data) {
                    try {
                        showMessage('Updating profile...', 'success');
                        
                        const response = await fetch('/update-profile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage('Profile updated successfully!', 'success');
                            // Reload page to reflect changes
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        } else {
                            showMessage(result.message || 'Failed to update profile', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        showMessage('Failed to update profile. Please try again.', 'error');
                    }
                }
                
                async function updatePassword(newPassword) {
                    try {
                        const response = await fetch('/update-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ password: newPassword })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage('Password updated successfully!', 'success');
                        } else {
                            alert(result.message || 'Failed to update password. Please try again.');
                            showPasswordChangeForm();
                        }
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Failed to update password. Please try again.');
                        showPasswordChangeForm();
                    }
                }
                
                // Close modals with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (otpModal.classList.contains('active')) {
                            closeOtpModal();
                        } else if (modal.classList.contains('active')) {
                            closeModal();
                        } else if (passwordModal.classList.contains('active')) {
                            closePasswordModal();
                        }
                    }
                });
                
                // Add loading states to buttons
                document.addEventListener('submit', function(e) {
                    const form = e.target;
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        const originalText = submitBtn.textContent;
                        submitBtn.innerHTML = '<span>‚è≥</span> Processing...';
                        submitBtn.disabled = true;
                        
                        
                        setTimeout(() => {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }, 3000);
                    }
                });
        // === Address Modal Functionality ===
const openAddressModalBtn = document.getElementById("openAddressModalBtn");
const openAddressesBtn = document.getElementById("openAddressesBtn");
const addressModal = document.getElementById("addressModalBox");
const closeAddressModal = document.getElementById("closeAddressModal");
const addressForm = document.getElementById("addressForm");

// === Open Modal from Either Button ===
function openAddressModal() {
  addressModal.style.display = "flex";
}

if (openAddressModalBtn) {
  openAddressModalBtn.addEventListener("click", openAddressModal);
}

if (openAddressesBtn) {
  openAddressesBtn.addEventListener("click", (e) => {
    e.preventDefault();
    openAddressModal();
  });
}

// === Close Modal ===
if (closeAddressModal) {
  closeAddressModal.addEventListener("click", () => {
    addressModal.style.display = "none";
  });
}

// === Close Modal When Clicking Outside ===
if (addressModal) {
  addressModal.addEventListener("click", (e) => {
    if (e.target === addressModal) {
      addressModal.style.display = "none";
    }
  });
}

// === Handle Form Submission ===
if (addressForm) {
  addressForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = addressForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = "Saving...";
    submitBtn.disabled = true;

    const formData = new FormData(addressForm);
    const payload = Object.fromEntries(formData.entries());

    try {
      const response = await fetch("/add-address", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify(payload),
      });

      const responseText = await response.text();

      try {
        const data = JSON.parse(responseText);
        if (data.success) {
          addressForm.reset();
          addressModal.style.display = "none";
          alert("Address added successfully!");
        } else {
          alert(data.message || "Unable to save address");
        }
      } catch {
        if (response.ok) {
          addressForm.reset();
          addressModal.style.display = "none";
          alert("Address added successfully!");
        } else {
          alert("Server returned an unexpected response.");
        }
      }
    } catch (err) {
      alert("Network error: " + err.message);
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
}


// Helper functions
function escapeHtml(text) {
    if (!text && text !== 0) return "";
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function showTempMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, 3000);
}

// Placeholder functions for edit/delete (you can implement these later)
function editAddress(index) {
    alert('Edit address functionality coming soon!');
}

function deleteAddress(index) {
    if (confirm('Are you sure you want to delete this address?')) {
        alert('Delete address functionality coming soon!');
    }
}

                // === PROFILE PHOTO UPLOAD WITH CROP ===
let cropper;
const avatarInput = document.getElementById('avatarInput');
const avatarPreview = document.getElementById('avatarPreview');
const avatarInitials = document.getElementById('avatarInitials');
const profileAvatar = document.getElementById('profileAvatar');
const cropModal = document.getElementById('cropModal');
const cropImagePreview = document.getElementById('cropImagePreview');
const saveCroppedImage = document.getElementById('saveCroppedImage');
const cancelCrop = document.getElementById('cancelCrop');
const closeCropModal = document.getElementById('closeCropModal');

// === SELECT IMAGE ===
if (avatarInput) {
  avatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a JPG, PNG, or WEBP image.');
      avatarInput.value = '';
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      alert('Image must be smaller than 2MB.');
      avatarInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      cropImagePreview.src = reader.result;
      cropModal.style.display = 'flex';

      if (cropper) cropper.destroy();
      cropper = new Cropper(cropImagePreview, {
        aspectRatio: 1,
        viewMode: 2,
        background: false,
        autoCropArea: 1,
        zoomable: true,
        movable: true,
        dragMode: 'move',
      });
    };
    reader.readAsDataURL(file);
  });
}

// === CANCEL CROPPING ===
function closeCrop() {
  cropModal.style.display = 'none';
  if (cropper) cropper.destroy();
  avatarInput.value = '';
}

cancelCrop?.addEventListener('click', closeCrop);
closeCropModal?.addEventListener('click', closeCrop);

// === SAVE CROPPED IMAGE ===
saveCroppedImage?.addEventListener('click', async () => {
  if (!cropper) return;

  const canvas = cropper.getCroppedCanvas({
    width: 400,
    height: 400,
    fillColor: '#fff'
  });

  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));

  cropModal.style.display = 'none';
  const previewUrl = URL.createObjectURL(blob);

  // Preview image immediately
  if (avatarPreview) {
    avatarPreview.src = previewUrl;
  } else {
    const img = document.createElement('img');
    img.src = previewUrl;
    img.id = 'avatarPreview';
    profileAvatar.innerHTML = '';
    profileAvatar.appendChild(img);
  }

  // Upload cropped image
  const formData = new FormData();
  formData.append('profileImage', blob, 'profile.jpg');

  try {
    const res = await fetch('/upload-profile-image', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.success) {
      showTempMessage('‚úÖ Profile photo updated!', 'success');
      // Force refresh cache
      document.getElementById('avatarPreview').src = data.imageUrl + '?t=' + Date.now();
    } else {
      showTempMessage(data.message || 'Failed to upload image', 'error');
    }
  } catch (err) {
    console.error(err);
    showTempMessage('‚ùå Upload error', 'error');
  } finally {
    cropper.destroy();
    avatarInput.value = '';
  }
});

// ‚úÖ Helper toast message
function showTempMessage(msg, type) {
  const div = document.createElement('div');
  div.textContent = msg;
  div.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    color: #fff;
    background: ${type === 'success' ? '#28a745' : '#dc3545'};
    border-radius: 8px;
    z-index: 99999;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    font-size: 14px;
  `;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2500);
}
            </script>
            </body>
            </html> `