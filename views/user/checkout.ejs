<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/user/header') %>
 <title>Checkout | Premium Store</title>

      <link rel="stylesheet" href="/user/checkout.css">
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
         <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
/>
</head>
<body>
   <!-- Premium Header -->
 
  
       
 <div class="checkout-container">

  <!-- LEFT SIDE -->
  <section class="left-section">

    <!-- üõí CART TABLE -->
    <h2 class="section-heading">üõí Your Cart</h2>

    <% if (cart && cart.items.length > 0) { %>
      <table class="cart-table">
  <thead>
    <tr>
      <th>Image</th>
      <th>Product</th>
      <th>Size</th>
      <th>Quantity</th>
      <th>Price</th>
    </tr>
  </thead>
  <tbody>
    <% cart.items.forEach(item => { %>
      <tr>
        <td>
          <img src="<%= item.productId?.productImage?.[0] || '/images/no-image.jpg' %>" 
               alt="<%= item.productId?.productName || 'Product' %>">
        </td>
        <td><%= item.productId?.productName || 'Unknown Product' %></td>
        <td><%= item.size %></td>
        <td><%= item.quantity %></td>
        <td>‚Çπ<%= item.totalprice.toLocaleString() %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

    <% } else { %>
      <p>No items in cart.</p>
    <% } %>

    <!-- SAVED ADDRESSES -->
     <div id="addressContainer">
<h2 class="section-heading">üè† Shipping Address</h2>

<% if (address) { %>
  <div class="address-card">
    <input type="hidden" name="addressId" value="<%= address._id %>">
    <b><%= address.addressType %></b>
    <div>
      <%= address.name %><br>
      <%= address.city %>, <%= address.state %><br>
      Pincode: <%= address.pincode %><br>
      Phone: <%= address.phone %>
    </div>
    <div class="actions">
      <button class="edit" type="button" onclick="openEditModal('<%= address._id %>')">‚úèÔ∏è Edit</button>
      <button class="delete" type="button" onclick="deleteAddress('<%= address._id %>')">üóëÔ∏è Delete</button>
    </div>
  </div>
<% } else { %>
  <p>No saved address found.</p>
  <button class="add" id="openAddModal"><span class="btn-icon">‚ûï</span> Add Address</button>
<% } %>
</div>


  </section>

  <!-- RIGHT SIDE -->
<section class="right-section">

 <h2 class="section-heading">
  <i class="fa-solid fa-receipt"></i>
  Order Summary
</h2>

  <div class="order-summary">
  <p>Subtotal: <span>‚Çπ<%= subtotal.toLocaleString() %></span></p>
  <p>Tax (5%): <span>‚Çπ<%= tax.toLocaleString() %></span></p>
  <p>Shipping: <span>‚Çπ<%= shipping.toLocaleString() %></span></p>

  <% if (appliedCoupon) { %>
    <p style="color: green;">
      Coupon (<%= appliedCoupon.code %>): 
      <span>- ‚Çπ<%= appliedCoupon.discount %></span>
    </p>
  <% } %>

  <p><strong>Total: <span>‚Çπ<%= finalTotal.toLocaleString() %></span></strong></p>
</div>

  <div class="coupon-section">
  <div class="coupon-row">
    <input type="text" id="couponInput" placeholder="Enter coupon code" class="coupon-input">

    <button onclick="applyCoupon()" class="apply-coupon-btn">Apply</button>

    <button id="removeCouponBtn" onclick="removeCoupon()" class="remove-coupon-btn">
      Remove
    </button>
  </div>

    
 <div class="coupon-dropdown-container">
  <button class="dropdown-toggle" onclick="toggleCouponDropdown()">‚ñº Select Coupon</button>

 <div id="couponDropdown" class="coupon-dropdown hidden">
<% 
const validCoupons = coupons.filter(c => {
  const now = new Date();
  const expiry = new Date(c.expiry);

  const isExpired = expiry < now;
  const notMinAmount = subtotal < c.minPurchase;
  const alreadyUsed = c.usedUsers.includes(String(user._id));
  const inactive = !c.isActive;

  return !(isExpired || notMinAmount || alreadyUsed || inactive);
});
%>

<% if (validCoupons.length === 0) { %>
  <div class="no-coupon">No valid coupons available</div>
<% } %>

<% validCoupons.forEach(c => { %>
  <div class="coupon-item active"
       onclick="applySelectedCoupon('<%= c.code %>')">
      <span><%= c.code %> ‚Äî <%= c.name %></span>
      <span class="apply-btn">Apply</span>
  </div>
<% }) %>

  </div>
</div>

  </div>

  


  <p id="couponMessage" class="coupon-message"></p>

  
<!-- üè¶ PAYMENT OPTIONS -->
<% const canUseWallet = wallet && wallet.balance >= finalTotal; %>

<div class="payment-section">
  <h3>Select Payment Method</h3>

  <!-- Show wallet balance -->
  <p>Wallet Balance: ‚Çπ<%= wallet.balance.toLocaleString() %></p>

  <div class="payment-options">

    <label class="payment-option <%= finalTotal > 1000 ? 'disabled' : '' %>">
  <input
    type="radio"
    name="paymentMethod"
    value="COD"
    <%= finalTotal > 1000 ? 'disabled' : 'checked' %>
  >
  <span>
  <i class="fa-solid fa-money-bill-wave"></i>
  Cash on Delivery
</span>


  <% if (finalTotal > 1000) { %>
    <small>COD not available above ‚Çπ1000</small>
  <% } %>
</label>


    <label class="payment-option">
      <input type="radio" name="paymentMethod" value="Razorpay">
      <span>
  <i class="fa-solid fa-credit-card"></i>
  Pay Online (Razorpay)
</span>

    </label>

    <label class="payment-option <%= !canUseWallet ? 'disabled' : '' %>">
      <input
        type="radio"
        name="paymentMethod"
        value="Wallet"
        <%= !canUseWallet ? 'disabled' : '' %>
      >
    <span>
  <i class="fa-solid fa-wallet"></i>
  Wallet 
  (Balance: ‚Çπ<%= wallet.balance.toLocaleString() %>)
</span>


      <% if (!canUseWallet) { %>
        <small>Not enough balance</small>
      <% } %>
    </label>

  </div>
</div>



  <!--  PLACE ORDER BUTTON -->
  <div class="final-checkout-actions">
    <button id="placeOrderBtn" class="confirm-order-btn">Confirm & Place Order</button>
  </div>

</section>

</div>

<!-- ü™Ñ ADD ADDRESS MODAL -->
 </main>
<!-- ‚úÖ CORRECT -->
<div id="addModal" class="hidden-modal" role="dialog" aria-modal="true">


  <div class="modal-content">
    <h3>Add New Address</h3>
    <form id="addForm" autocomplete="off">
      <select name="addressType" >
        <option value="">Type</option>
        <option value="Home">üè° Home</option>
        <option value="Work">üè¢ Work</option>
      </select>
      <input name="name" placeholder="Full name" />
      <div class="error-message"></div>
      <input name="city" placeholder="City"  />
      <div class="error-message"></div>
      <input name="landMark" placeholder="Landmark" />
      <div class="error-message"></div>
      <input name="state" placeholder="State"  />
      <div class="error-message"></div>
      <input name="pincode" placeholder="Pincode" type="number"  />
      <div class="error-message"></div>
      <input name="phone" placeholder="Phone"  />
      <div class="error-message"></div>
      <input name="altphone" placeholder="Alternate phone" />
      <div class="error-message"></div>
      <div class="modal-actions">
        <button class="add" type="submit">‚ûï Add Address</button>

        <button class="cancel-btn" type="button" onclick="closeAddModal()"><span class="btn-icon"></span> Cancel</button>
      </div>
    </form>
  </div>
</div>


  <!-- Modal content here -->

      
  <div id="editModal" class="hidden-modal">

    <div class="modal-content">
      <h3>Edit Address</h3>
      <form id="editForm">
        <input type="hidden" id="editId" name="id" />
        <select id="editType" name="addressType" required>
          <option value="Home">üè° Home</option>
          <option value="Work">üè¢ Work</option>
        </select>
        <input id="editName" name="name" placeholder="Full name" />
        <div class="error-message"></div>
        <input id="editCity" name="city" placeholder="City" />
        <div class="error-message"></div>
        <input id="editLandmark" name="landMark" placeholder="Landmark" />
        <div class="error-message"></div>
        <input id="editState" name="state" placeholder="State"  />
        <div class="error-message"></div>
        <input id="editPincode" name="pincode" placeholder="Pincode" type="number"  />
        <div class="error-message"></div>
        <input id="editPhone" name="phone" placeholder="Phone"  />
         <div class="error-message"></div>
        
        <input id="editAltphone" name="altphone" placeholder="Alternate phone" />
         <div class="error-message"></div>
        <div class="modal-actions">
          <button class="edit" type="submit"><span class="btn-icon">üíæ</span> Save</button>
          <button class="cancel-btn" type="button" onclick="closeModal()"><span class="btn-icon"></span> Cancel</button>
        </div>
      </form>
    </div>
  </div>


 <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
/* üîí HARD FIX ‚Äî runs BEFORE anything else */
   // Add this at the beginning of your script
    document.addEventListener('DOMContentLoaded', function() {
      
      
      // Add click handler for add address button
    
    });
/* ============================================================
   FORM VALIDATION (Add & Edit)
============================================================ */

function showError(field, message) {
  if (!field) return;
  field.classList.add("error");

  let err = field.nextElementSibling;
  if (!err || !err.classList.contains("error-message")) {
    err = document.createElement("div");
    err.className = "error-message";
    field.insertAdjacentElement("afterend", err);
  }
  err.textContent = message;
  err.style.display = "block";
}

function clearError(field) {
  let err = field.nextElementSibling;
  if (err && err.classList.contains("error-message")) {
    err.style.display = "none";
  }
  field.classList.remove("error");
}

function validateSingleField(field) {
  const value = field.value.trim();

  const namePattern = /^[A-Za-z\s.'-]{2,50}$/;
  const pincodePattern = /^\d{6}$/;
  const phonePattern = /^[6-9]\d{9}$/;
  const textPattern = /^[A-Za-z0-9\s.,'-]{2,100}$/;

  let valid = true;
  let message = "";

  switch (field.name) {
    case "addressType":
      valid = value !== "";
      message = "Please select an address type.";
      break;
    case "name":
      valid = namePattern.test(value);
      message = "Enter a valid full name.";
      break;
    case "city":
      valid = textPattern.test(value);
      message = "Enter a valid city.";
      break;
    case "landMark":
      valid = value === "" || textPattern.test(value);
      message = "Enter a valid landmark.";
      break;
    case "state":
      valid = textPattern.test(value);
      message = "Enter a valid state.";
      break;
    case "pincode":
      valid = pincodePattern.test(value);
      message = "Enter a valid 6-digit pincode.";
      break;
    case "phone":
      valid = phonePattern.test(value);
      message = "Enter a valid phone number.";
      break;
    case "altphone":
      valid = value === "" || phonePattern.test(value);
      message = "Enter a valid alternate number.";
      break;
  }

  if (!valid) showError(field, message);
  else clearError(field);

  return valid;
}

function validateAddressForm(form) {
  let isValid = true;
  [...form.elements].forEach((field) => {
    if (!field.name || ["button","submit","hidden"].includes(field.type)) return;
    if (!validateSingleField(field)) isValid = false;
  });
  return isValid;
}

// Real-time validation in both modals
function activateLiveValidation(formSelector) {
  const form = document.querySelector(formSelector);
  if (!form) return;

  form.querySelectorAll("input, select").forEach((field) => {
    field.addEventListener("input", () => validateSingleField(field));
    field.addEventListener("blur", () => validateSingleField(field));
  });
}

activateLiveValidation("#addForm");
activateLiveValidation("#editForm");

/* ============================================================
   üîî Toast Notification System
============================================================ */
function showToast(message, type = "info") {
  let root = document.getElementById("toast-root");
  if (!root) {
    root = document.createElement("div");
    root.id = "toast-root";
    root.style.position = "fixed";
    root.style.bottom = "30px";
    root.style.right = "30px";
    root.style.zIndex = "9999";
    document.body.appendChild(root);
  }

  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.background =
    type === "error" ? "#E74C3C" : "linear-gradient(135deg, #D4AF37, #B8941F)";
  toast.style.color = type === "error" ? "#fff" : "#0B0B0F";
  toast.style.padding = "14px 28px";
  toast.style.borderRadius = "12px";
  toast.style.fontWeight = "600";
  toast.style.letterSpacing = "0.5px";
  toast.style.boxShadow = "0 8px 20px rgba(0,0,0,0.4)";
  toast.style.marginTop = "12px";
  toast.style.opacity = "0";
  toast.style.transition = "all 0.4s ease";

  root.appendChild(toast);
  setTimeout(() => (toast.style.opacity = "1"), 100);
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(10px)";
    setTimeout(() => toast.remove(), 400);
  }, 2500);
}

/* =============================
   üè† Render Single Address (AJAX)
============================= */
async function renderAddress() {
  try {
    const res = await fetch("/get-addresses");
    const data = await res.json();

    const addressContainer = document.getElementById("addressContainer");
    if (!addressContainer) return;

    let html = `<h2 class="section-heading">Shipping Address</h2>`;


    if (data.addresses && data.addresses.length > 0) {
      const latest = data.addresses[data.addresses.length - 1];

      html += `
        <div class="address-card">
          <input type="hidden" name="addressId" value="${latest._id}">
          <b>${latest.addressType}</b>
          <div style="margin-top:10px;">
            ${latest.name}<br>
            ${latest.city}, ${latest.state} - ${latest.pincode}<br>
            Phone: ${latest.phone}
          </div>
          <div class="actions" style="margin-top:10px;">
          <button class="edit" type="button" onclick="openEditModal('${latest._id}')">Edit</button>
<button class="delete" type="button" onclick="deleteAddress('${latest._id}')">Delete</button>
          </div>
        </div>`;
    } else {
      html += `
        <p>No saved address found.</p>
       <button class="add open-add-modal">Add Address</button>


`;
    }

    addressContainer.innerHTML = html;


    // Re-bind Add button after DOM update
    document
      .getElementById("openAddModal")
      ?.addEventListener("click", openAddModal);

  } catch (err) {
    showToast("‚ö†Ô∏è Failed to load address", "error");
  }
}

/* =============================
   ‚ûï Add / ‚úèÔ∏è Edit / ‚ùå Delete
============================= */
/* ============================================================
   MODAL CONTROLS (UNCHANGED)
============================================================ */
function openAddModal() {
  console.log(" OPEN ADD MODAL");
  const modal = document.getElementById("addModal");
  modal.classList.remove("hidden-modal");
  modal.style.display = "flex";
  modal.style.zIndex = "9999";
}

function closeAddModal() {
  document.getElementById("addModal").classList.add("hidden-modal");
}

function closeModal() {
  const modal = document.getElementById("editModal");
  modal.classList.add("hidden-modal");
  modal.style.display = "none";
}



async function openEditModal(id) {
  console.log("üü¢ Edit clicked:", id);

  try {
    const res = await fetch("/get-addresses");
    const data = await res.json();

    const addr = data.addresses.find(a => a._id === id);
    if (!addr) {
      showToast("Address not found", "error");
      return;
    }

    // Fill form
    editId.value = addr._id;
    editType.value = addr.addressType;
    editName.value = addr.name;
    editCity.value = addr.city;
    editLandmark.value = addr.landMark || "";
    editState.value = addr.state;
    editPincode.value = addr.pincode;
    editPhone.value = addr.phone;
    editAltphone.value = addr.altphone || "";

    // ‚úÖ OPEN MODAL PROPERLY
    const modal = document.getElementById("editModal");
    modal.classList.remove("hidden-modal");
    modal.style.display = "flex";
    modal.style.zIndex = "9999";

    console.log("‚úÖ Edit modal opened");

  } catch (err) {
    console.error("Edit modal error:", err);
    showToast("Failed to load address", "error");
  }
}


/* =============================
   üì¨ Add Address (AJAX)
============================= */
document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // VALIDATION BLOCK
  if (!validateAddressForm(e.target)) {
    showToast("‚ö†Ô∏è Please correct highlighted fields", "error");
    return;
  }

  const formData = Object.fromEntries(new FormData(e.target));

  const res = await fetch("/add-address", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formData),
  });
  const data = await res.json();

  if (data.success) {
    showToast("‚úÖ Address added successfully");
    closeAddModal();
    e.target.reset();
    await renderAddress();
  } else {
    showToast(data.message || "Failed to add address", "error");
  }
});

/* =============================
   ‚úèÔ∏è Edit Address (AJAX)
============================= */
document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // VALIDATION BLOCK
  if (!validateAddressForm(e.target)) {
    showToast("‚ö†Ô∏è Please correct highlighted fields", "error");
    return;
  }

  const id = document.getElementById("editId").value;
  const formData = Object.fromEntries(new FormData(e.target));

  const res = await fetch(`/edit-address/${id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formData),
  });
  const data = await res.json();

  if (data.success) {
    showToast("üíæ Address updated successfully");
    closeModal();
    await renderAddress();
  } else {
    showToast(data.message || "Failed to update address", "error");
  }
});

/* =============================
   ‚ùå
-delete Address code stays the same
============================= */

async function deleteAddress(id) {
  const result = await Swal.fire({
    title: "Delete Address?",
    text: "Are you sure you want to delete this address?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, delete it",
    cancelButtonText: "Cancel",
    reverseButtons: true,
    buttonsStyling: false,
    customClass: {
      popup: "premium-popup",
      confirmButton: "premium-confirm-btn",
      cancelButton: "premium-cancel-btn"
    }
  });

  if (!result.isConfirmed) return;

  const res = await fetch(`/delete-address/${id}`, { method: "DELETE" });
  const data = await res.json();

  if (data.success) {
    Swal.fire({
      icon: "success",
      title: "Deleted!",
      text: "The address has been removed.",
      timer: 1500,
      showConfirmButton: false,
      customClass: { popup: "premium-popup" }
    });

    await renderAddress();
  } else {
    Swal.fire({
      icon: "error",
      title: "Failed",
      text: data.message || "Failed to delete address",
      customClass: { popup: "premium-popup" }
    });
  }
}
async function initiateRazorpayPayment() {
  const btn = document.getElementById("placeOrderBtn");
  btn.disabled = true;

  try {
    const res = await fetch("/create-razorpay-order", { method: "POST" });
    const data = await res.json();

    if (!data.success) {
      showToast("Payment initialization failed", "error");
      btn.disabled = false;
      return;
    }

    const { key, razorpayOrderId, amountInPaise, internalOrderId } = data;

    const options = {
      key,
      amount: amountInPaise,
      currency: "INR",
      order_id: razorpayOrderId,
      name: "Your Store Name",
      description: "Order Payment",

      // ‚úÖ SUCCESS CALLBACK
      handler: async function (response) {
        try {
          const verifyRes = await fetch("/verify-razorpay-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...response,
              internalOrderId
            })
          });

          const verifyData = await verifyRes.json();

          if (verifyData.success) {
            window.location.href = `/order-success/${verifyData.orderId}`;
          } else {
            window.location.href = `/order-failure?orderId=${internalOrderId}`;
          }
        } catch (err) {
          window.location.href = `/order-failure?orderId=${internalOrderId}`;
        }
      },

      // ‚ùå NO FAILURE LOGIC HERE
      modal: {
        ondismiss: function () {
          console.log("Razorpay modal closed");
        }
      }
    };

    const rzpFinal = new Razorpay(options);

    // REAL FAILURE EVENT
    rzpFinal.on("payment.failed", async function (response) {
      await fetch("/mark-payment-failed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          internalOrderId,
          reason: response.error.description || "Payment Failed"
        })
      });

      window.location.href = `/order-failure?orderId=${internalOrderId}`;
    });

    rzpFinal.open();

  } catch (err) {
    console.error("Razorpay init error:", err);
    showToast("Something went wrong", "error");
    btn.disabled = false;
  }
}


let razorpayInProgress = false;

document.getElementById("placeOrderBtn").addEventListener("click", async () => {
  if (razorpayInProgress) return;

  const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
  if (!selectedPayment) {
    showToast("Please select a payment method", "error");
    return;
  }

  razorpayInProgress = true;

  if (selectedPayment.value === "COD") {
    razorpayInProgress = false;
    return placeCODOrder();
  }

  if (selectedPayment.value === "Wallet") {
    razorpayInProgress = false;
    return placeWalletOrder();
  }

  if (selectedPayment.value === "Razorpay") {
    return initiateRazorpayPayment();
  }
});


/* =============================
   ‚öôÔ∏è Initialize
============================= */
document.addEventListener("DOMContentLoaded", renderAddress);
document.addEventListener("keydown", function (e) {
  if (e.key === "Escape") {
    closeAddModal();
    closeModal();
  }
});
async function placeCODOrder() {
  try {
    const res = await fetch("/place-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentMethod: "COD" }),
    });

    const data = await res.json();

    if (data.success) {
      showToast("Order placed successfully!", "success");
      window.location.href = `/order-success/${data.orderId}`;
    } else {
      showToast(data.message || "Order failed", "error");
      document.getElementById("placeOrderBtn").disabled = false;
    }
  } catch (err) {
    console.error("Order placement error:", err);
    showToast("Something went wrong. Try again.", "error");
    document.getElementById("placeOrderBtn").disabled = false;
  }
}


function toggleCouponDropdown() {
  document.getElementById("couponDropdown").classList.toggle("hidden");
}


async function applyCoupon() {
  const code = document.getElementById("couponInput").value.trim().toUpperCase();
  if (!code) return showToast("Enter a coupon code", "error");

  console.log("Sending coupon:", code);

  const res = await fetch("/apply-coupon", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code }),
  });

  const data = await res.json();

  if (data.success) {
    document.getElementById("couponMessage").innerHTML = "Discount: ‚Çπ" + data.discount;
    document.getElementById("removeCouponBtn").style.display = "block";

    setTimeout(() => location.reload(), 150);
  } else {
    showToast(data.message, "error"); // ‚úÖ No alert ‚Äî toast only
  }
}
async function removeCoupon() {
  const res = await fetch("/remove-coupon", { method: "POST" });
  const data = await res.json();

  if (data.success) {
    document.getElementById("couponInput").value = "";
    location.reload();
  }
}



window.applySelectedCoupon = function (code) {
    document.getElementById("couponInput").value = code.trim().toUpperCase();

    // Close dropdown after selecting
    document.getElementById("couponDropdown").classList.add("hidden");
};
// Close dropdown when clicking outside
document.addEventListener("click", function (e) {
    const dropdown = document.getElementById("couponDropdown");
    const toggleBtn = document.querySelector(".dropdown-toggle");

    // If dropdown is open AND click is outside ‚Üí close
    if (!dropdown.classList.contains("hidden")) {
        if (!dropdown.contains(e.target) && e.target !== toggleBtn) {
            dropdown.classList.add("hidden");
        }
    }
});


async function placeWalletOrder() {
  try {
    const res = await fetch("/place-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentMethod: "Wallet" })
    });

    const data = await res.json();

    if (data.success) {
      showToast("Wallet payment successful!", "success");
      window.location.href = `/order-success/${data.orderId}`;
    } else {
      showToast(data.message || "Wallet payment failed", "error");
    }

  } catch (err) {
    console.error("Wallet order error:", err);
    showToast("Something went wrong. Try again.", "error");
  }
}
/* ‚úÖ SINGLE SOURCE OF TRUTH ‚Äî ADD ADDRESS */
document.addEventListener("click", function (e) {
  if (e.target.closest("#openAddModal") || e.target.closest(".open-add-modal")) {
    console.log("üü¢ Add Address button clicked");
    openAddModal();
  }
});


</script>










</body>
</html>
