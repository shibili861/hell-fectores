<%- include('../partials/user/header') %>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

:root {
  --gold: #D4AF37;
  --light-gold: #F4E4C1;
  --dark-gold: #B8941F;
  --cream: #FFF8E7;
  --dark-bg: #0B0B0F;
  --card-bg: #13131A;
  --border: #2A2A35;
  --text-primary: #F5F5F7;
  --text-secondary: #A0A0AB;
  --accent: #1E1E28;
}

body {
  background: linear-gradient(135deg, #0B0B0F 0%, #1A1A24 100%);
  color: var(--text-primary);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
}

.cart-wrapper {
  max-width: 1400px;
  margin: 0 auto;
  padding: 80px 2rem 100px;
}

.cart-header {
  text-align: center;
  margin-bottom: 60px;
  position: relative;
}

.cart-header::before {
  content: '';
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}

.cart-header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 3.5rem;
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.cart-header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
  letter-spacing: 1px;
}

/* Cart Items Table */
.cart-table-container {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 40px;
  margin-bottom: 40px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  overflow-x: auto;
}

.cart-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 12px;
}

.cart-table thead th {
  font-family: 'Playfair Display', serif;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 20px 16px;
  text-align: left;
  border-bottom: 2px solid var(--gold);
}

.cart-table tbody tr {
  background: var(--accent);
  transition: all 0.3s ease;
}

.cart-table tbody tr:hover {
  background: rgba(212, 175, 55, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(212, 175, 55, 0.15);
}

.cart-table tbody td {
  padding: 24px 16px;
  vertical-align: middle;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.cart-table tbody tr td:first-child {
  border-left: 1px solid var(--border);
  border-top-left-radius: 12px;
  border-bottom-left-radius: 12px;
}

.cart-table tbody tr td:last-child {
  border-right: 1px solid var(--border);
  border-top-right-radius: 12px;
  border-bottom-right-radius: 12px;
}

.product-info {
  display: flex;
  align-items: center;
  gap: 20px;
  min-width: 300px;
}

.product-image {
  width: 90px;
  height: 90px;
  object-fit: cover;
  border-radius: 12px;
  border: 2px solid var(--gold);
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.product-details h3 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 6px;
  transition: color 0.3s;
}

.product-details h3:hover {
  color: var(--gold);
}

.product-category {
  font-size: 0.85rem;
  color: var(--text-secondary);
  letter-spacing: 1px;
}

.price-cell {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--gold);
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--dark-bg);
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
}

.qty-btn {
  background: var(--gold);
  color: var(--dark-bg);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  font-size: 1.2rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.qty-btn:hover {
  background: var(--light-gold);
  transform: scale(1.15);
}

.qty-display {
  font-size: 1.1rem;
  font-weight: 600;
  min-width: 40px;
  text-align: center;
  color: var(--text-primary);
}

.total-cell {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--gold);
}

.remove-btn {
  background: transparent;
  color: #E74C3C;
  border: 1px solid #E74C3C;
  padding: 8px 20px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.remove-btn:hover {
  background: #E74C3C;
  color: white;
  transform: scale(1.05);
}

/* Summary Table */
.summary-section {
  display: grid;
  grid-template-columns: 1fr 450px;
  gap: 40px;
  align-items: start;
}

.continue-shopping {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: var(--card-bg);
  color: var(--gold);
  padding: 16px 32px;
  border-radius: 12px;
  border: 1px solid var(--gold);
  text-decoration: none;
  font-weight: 600;
  letter-spacing: 1px;
  transition: all 0.3s ease;
}

.continue-shopping:hover {
  background: var(--gold);
  color: var(--dark-bg);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
}

.summary-container {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 40px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.summary-header {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 30px;
  text-align: center;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.summary-table {
  width: 100%;
  margin-bottom: 30px;
}

.summary-table tr {
  border-bottom: 1px solid var(--border);
}

.summary-table tr:last-child {
  border-bottom: 2px solid var(--gold);
  border-top: 2px solid var(--gold);
}

.summary-table td {
  padding: 16px 0;
  font-size: 1rem;
}

.summary-label {
  color: var(--text-secondary);
  font-weight: 500;
  letter-spacing: 1px;
}

.summary-value {
  text-align: right;
  color: var(--text-primary);
  font-weight: 600;
  font-size: 1.1rem;
}

.summary-table tr:last-child .summary-label {
  color: var(--gold);
  font-size: 1.3rem;
  font-weight: 700;
  text-transform: uppercase;
}

.summary-table tr:last-child .summary-value {
  color: var(--gold);
  font-size: 1.8rem;
  font-weight: 700;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 30px;
}

.checkout-btn, .clear-btn {
  padding: 18px 32px;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid;
}

.checkout-btn {
  background: linear-gradient(135deg, var(--gold), var(--dark-gold));
  color: var(--dark-bg);
  border-color: var(--gold);
}

.checkout-btn:hover {
  background: var(--light-gold);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(212, 175, 55, 0.4);
}

.clear-btn {
  background: transparent;
  color: #E74C3C;
  border-color: #E74C3C;
}

.clear-btn:hover {
  background: #E74C3C;
  color: white;
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(231, 76, 60, 0.3);
}

/* Empty Cart */
.empty-cart {
  text-align: center;
  padding: 100px 40px;
  background: var(--card-bg);
  border-radius: 20px;
  border: 1px solid var(--border);
}

.empty-cart-icon {
  font-size: 8rem;
  margin-bottom: 30px;
  opacity: 0.5;
}

.empty-cart h2 {
  font-family: 'Playfair Display', serif;
  font-size: 2.5rem;
  color: var(--gold);
  margin-bottom: 16px;
}

.empty-cart p {
  color: var(--text-secondary);
  font-size: 1.2rem;
  margin-bottom: 40px;
}

.empty-cart a {
  display: inline-block;
  background: var(--gold);
  color: var(--dark-bg);
  padding: 16px 48px;
  border-radius: 12px;
  font-weight: 700;
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: all 0.3s ease;
}

.empty-cart a:hover {
  background: var(--light-gold);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(212, 175, 55, 0.4);
}

/* Toast */
#toast-root {
  position: fixed;
  bottom: 40px;
  right: 40px;
  z-index: 1000;
}

.toast {
  background: var(--card-bg);
  border: 1px solid var(--gold);
  color: var(--text-primary);
  padding: 16px 32px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  margin-bottom: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  animation: slideIn 0.3s ease;
}

.toast.error {
  border-color: #E74C3C;
  color: #E74C3C;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.loading {
  text-align: center;
  padding: 60px;
  color: var(--text-secondary);
  font-size: 1.2rem;
}

/* Responsive */
@media (max-width: 1200px) {
  .summary-section {
    grid-template-columns: 1fr;
  }
  
  .cart-wrapper {
    padding: 60px 1.5rem 80px;
  }
}

@media (max-width: 768px) {
  .cart-header h1 {
    font-size: 2.5rem;
  }
  
  .cart-table-container {
    padding: 20px;
    overflow-x: scroll;
  }
  
  .cart-table {
    min-width: 800px;
  }
  
  .summary-container {
    padding: 30px 20px;
  }
  
  .product-info {
    min-width: 250px;
  }
}
</style>

<div class="cart-wrapper">
  <div class="cart-header">
    <h1>üõí Shopping Cart</h1>
    <p>Review your premium selections</p>
  </div>

  <div id="cart-root">
    <div class="loading">Loading your cart...</div>
  </div>
</div>

<div id="toast-root"></div>
<script>
  // Format currency
  const currency = (amt) => '‚Çπ' + Number(amt).toFixed(2);

  // Simple toast message
  function showToast(msg, type = 'info') {
    const root = document.getElementById('toast-root');
    const el = document.createElement('div');
    el.className = `toast ${type === 'error' ? 'error' : ''}`;
    el.textContent = msg;
    root.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  // Fetch cart data
  async function fetchCart() {
    try {
      const res = await fetch('/api/cart');
      return await res.json();
    } catch {
      showToast('Error loading cart', 'error');
      return { success: false, cart: { items: [] } };
    }
  }

  // Remove product from cart
  async function removeItem(productId) {
    try {
      const res = await fetch(`/api/cart/${productId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        showToast('üóëÔ∏è Item removed');
        renderCart();
      } else showToast(data.message || 'Could not remove item', 'error');
    } catch {
      showToast('Error removing item', 'error');
    }
  }

  // Change quantity (increase/decrease)
  async function changeQuantity(productId, delta) {
    try {
      const res = await fetch(`/api/cart/${productId}/quantity`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantityDelta: delta }),
      });
      const data = await res.json();
      if (data.success) renderCart();
      else showToast(data.message || 'Could not update quantity', 'error');
    } catch {
      showToast('Error updating quantity', 'error');
    }
  }

  // Render cart table
  async function renderCart() {
    const root = document.getElementById('cart-root');
    root.innerHTML = `<div class="loading">Loading your cart...</div>`;

    const data = await fetchCart();
    if (!data.success) {
      root.innerHTML = `<div class="empty-cart">‚ùå Failed to load cart</div>`;
      return;
    }

    const items = data.cart?.items || [];
    if (items.length === 0) {
      root.innerHTML = `
        <div class="empty-cart">
          <h2>Your Cart is Empty üõí</h2>
          <a href="/products">Continue Shopping</a>
        </div>`;
      return;
    }

    let subtotal = 0;
    const rows = items.map(item => {
      const product = item.productId;
      const qty = item.quantity;
      const price = item.price || product.salePrice || product.regularPrice;
      const total = price * qty;
      subtotal += total;
      return `
        <tr data-id="${product._id}">
          <td>
            <div class="product-info">
              <img src="${product.productImage?.[0] || '/images/no-image.jpg'}" class="product-image">
              <div>
                <h3>${product.productName}</h3>
                <small>${product.category?.name || ''}</small>
              </div>
            </div>
          </td>
          <td>${currency(price)}</td>
          <td>
            <div class="quantity-controls">
              <button class="qty-btn" onclick="changeQuantity('${product._id}', -1)" ${qty <= 1 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>‚àí</button>
              <div class="qty-display">${qty}</div>
              <button class="qty-btn" onclick="changeQuantity('${product._id}', 1)" ${qty >= 3 ? 'disabled style="opacity:0.5;cursor:not-allowed;" title="Maximum 3 items allowed"' : ''}>+</button>
            </div>
            ${qty >= 3 ? '<div style="color:#E74C3C;font-size:0.8rem;">Max limit reached</div>' : ''}
          </td>
          <td>${currency(total)}</td>
          <td><button class="remove-btn" onclick="removeItem('${product._id}')">Remove</button></td>
        </tr>`;
    }).join('');

    root.innerHTML = `
      <div class="cart-table-container">
        <table class="cart-table">
          <thead>
            <tr><th>Product</th><th>Price</th><th>Quantity</th><th>Total</th><th></th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="summary">
        <p>Subtotal: <strong id="subtotal">${currency(subtotal)}</strong></p>
        <button id="checkout-btn" class="checkout-btn">Proceed to Checkout</button>
      </div>`;
  }

  document.addEventListener('DOMContentLoaded', renderCart);
</script>


<%- include('../partials/user/footer') %>