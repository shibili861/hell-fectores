 <%- include('../partials/admin/sidebar') %>
<style>
/* ============================================
   ORDER MANAGEMENT ADMIN PANEL - FIXED STYLING
   Fixed sidebar overlap, table alignment & pagination
   ============================================ */

/* Reset and base styles to prevent overlap */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  /* Color palette */
  --primary-brown: #8B4513;
  --dark-brown: #5D4037;
  --medium-brown: #795548;
  --light-brown: #D7CCC8;
  --cream: #F5F1E8;
  --accent-gold: #D4AF37;
  --soft-gold: #FFE082;
  
  /* Sidebar dimensions */
  --sidebar-width: 280px;
  --sidebar-collapsed: 70px;
  
  /* Spacing */
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
}

/* ========== MAIN LAYOUT FIXES ========== */
body {
  background-color: #f9f6f2;
  color: #333;
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Main content area - Adjusted for sidebar */
.container.mt-4 {
  flex: 1;
  padding: var(--spacing-xl);
  margin-left: var(--sidebar-width);
  transition: margin-left 0.3s ease;
  max-width: calc(100vw - var(--sidebar-width));
  overflow-x: auto;
  min-height: 100vh;
}

/* When sidebar is collapsed */
.sidebar.collapsed ~ .container.mt-4 {
  margin-left: var(--sidebar-collapsed);
  max-width: calc(100vw - var(--sidebar-collapsed));
}

/* Mobile adjustments */
@media (max-width: 992px) {
  .container.mt-4 {
    margin-left: 0 !important;
    max-width: 100vw;
    padding: 1rem;
  }
  
  .sidebar.active ~ .container.mt-4 {
    margin-left: 0 !important;
  }
}

/* ========== HEADER STYLING ========== */
h2.mb-4 {
  color: var(--dark-brown);
  font-weight: 700;
  font-size: 2rem;
  margin-bottom: var(--spacing-xl) !important;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--light-brown);
  position: relative;
}

h2.mb-4::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: -2px;
  width: 80px;
  height: 3px;
  background: linear-gradient(to right, var(--primary-brown), var(--accent-gold));
}

/* ========== FILTER SECTION ========== */
form.d-flex.gap-2.mb-3 {
  background: white;
  padding: var(--spacing-lg);
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(139, 69, 19, 0.08);
  margin-bottom: var(--spacing-xl) !important;
  border: 1px solid var(--light-brown);
  display: flex;
  flex-wrap: wrap;
  gap: 12px !important;
  align-items: center;
}

.form-control, .form-select {
  border: 1.5px solid var(--light-brown);
  border-radius: 6px;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  transition: all 0.3s ease;
  min-height: 48px;
  flex: 1;
  min-width: 150px;
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary-brown);
  box-shadow: 0 0 0 0.25rem rgba(139, 69, 19, 0.15);
  outline: none;
}

.btn-primary, .btn-secondary {
  border-radius: 6px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  min-height: 48px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-brown), var(--dark-brown));
  color: white;
}

.btn-primary:hover {
  background: linear-gradient(135deg, var(--dark-brown), var(--primary-brown));
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(139, 69, 19, 0.12);
}

/* ========== TABLE FIXES ========== */
/* Table container to prevent overflow */
.table-responsive-wrapper {
  overflow-x: auto;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(139, 69, 19, 0.12);
  border: 1px solid var(--light-brown);
  background: white;
  margin-bottom: var(--spacing-xl);
  position: relative;
}

.table {
  width: 100%;
  margin-bottom: 0;
  border-collapse: separate;
  border-spacing: 0;
}

/* Fixed table header */
.table thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

.table thead.table-dark {
  background: linear-gradient(to right, var(--dark-brown), var(--primary-brown));
  color: white;
}

.table thead th {
  padding: 1.25rem 0.75rem;
  font-weight: 700;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: none;
  vertical-align: middle;
  white-space: nowrap;
  position: relative;
}

/* Ensure header cells align with body cells */
.table thead th,
.table tbody td {
  min-width: 120px;
  padding: 1rem 0.75rem;
}

/* Specific column widths for consistency */
.table thead th:nth-child(1), /* Order ID */
.table tbody td:nth-child(1) {
  min-width: 80px;
  text-align: center;
}

.table thead th:nth-child(2), /* Date */
.table tbody td:nth-child(2) {
  min-width: 180px;
}

.table thead th:nth-child(3), /* User */
.table tbody td:nth-child(3) {
  min-width: 150px;
}

.table thead th:nth-child(4), /* Email */
.table tbody td:nth-child(4) {
  min-width: 200px;
}

.table thead th:nth-child(5), /* Status */
.table tbody td:nth-child(5) {
  min-width: 130px;
}

.table thead th:nth-child(6), /* Change Status */
.table tbody td:nth-child(6) {
  min-width: 200px;
}

.table thead th:nth-child(7), /* Total */
.table tbody td:nth-child(7) {
  min-width: 120px;
}

.table thead th:nth-child(8), /* Return Request */
.table tbody td:nth-child(8) {
  min-width: 250px;
}

.table thead th:nth-child(9), /* Action */
.table tbody td:nth-child(9) {
  min-width: 100px;
  text-align: center;
}

/* Table body styling */
.table tbody tr {
  transition: all 0.2s ease;
  border-bottom: 1px solid rgba(139, 69, 19, 0.08);
}

.table tbody tr:hover {
  background-color: rgba(139, 69, 19, 0.03);
}

.table tbody td {
  vertical-align: middle;
  border-top: 1px solid rgba(139, 69, 19, 0.08);
  font-size: 0.95rem;
  padding: 1rem 0.75rem;
}

/* Status badges */
.status-badge {
  display: inline-block;
  padding: 0.4rem 0.9rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-width: 100px;
  text-align: center;
}

/* ========== PAGINATION FIXES ========== */
/* Pagination container */
nav {
  display: flex;
  justify-content: center;
  margin-top: var(--spacing-xl);
  margin-bottom: var(--spacing-xl);
  width: 100%;
}

.pagination {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  align-items: center;
  padding: 0.75rem;
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(139, 69, 19, 0.08);
  border: 1px solid var(--light-brown);
  max-width: 100%;
  overflow-x: auto;
}

.page-item {
  margin: 0;
}

.page-item.active .page-link {
  background: linear-gradient(135deg, var(--primary-brown), var(--dark-brown));
  border-color: var(--primary-brown);
  color: white;
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(139, 69, 19, 0.2);
}

.page-link {
  color: var(--primary-brown);
  border: 1px solid var(--light-brown);
  padding: 0.6rem 1rem;
  border-radius: 6px;
  transition: all 0.3s ease;
  font-weight: 500;
  min-width: 44px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 44px;
}

.page-link:hover {
  background-color: rgba(139, 69, 19, 0.08);
  color: var(--dark-brown);
  border-color: var(--primary-brown);
  transform: translateY(-2px);
  text-decoration: none;
}

/* ========== RESPONSIVE FIXES ========== */
@media (max-width: 1200px) {
  :root {
    --sidebar-width: 240px;
  }
  
  .container.mt-4 {
    padding: 1.5rem;
  }
  
  .table thead th,
  .table tbody td {
    min-width: 100px;
    padding: 0.875rem 0.5rem;
  }
}

@media (max-width: 992px) {
  /* Mobile table adjustments */
  .table-responsive-wrapper {
    border-radius: 8px;
  }
  
  .table {
    min-width: 900px; /* Enable horizontal scroll on mobile */
  }
  
  .pagination {
    padding: 0.5rem;
    gap: 0.3rem;
  }
  
  .page-link {
    padding: 0.5rem 0.75rem;
    min-width: 40px;
    height: 40px;
    font-size: 0.9rem;
  }
}

@media (max-width: 768px) {
  .container.mt-4 {
    padding: 1rem;
  }
  
  h2.mb-4 {
    font-size: 1.5rem;
  }
  
  form.d-flex.gap-2.mb-3 {
    flex-direction: column;
    align-items: stretch;
  }
  
  .form-control, .form-select, .btn-primary, .btn-secondary {
    width: 100%;
    min-width: 100%;
  }
  
  .pagination {
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: flex-start;
  }
}

@media (max-width: 576px) {
  .container.mt-4 {
    padding: 0.75rem;
  }
  
  .table thead th,
  .table tbody td {
    padding: 0.75rem 0.5rem;
    font-size: 0.9rem;
  }
  
  .status-badge {
    min-width: 80px;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
  }
  
  .pagination {
    border-radius: 8px;
  }
  
  .page-link {
    padding: 0.4rem 0.6rem;
    min-width: 36px;
    height: 36px;
    font-size: 0.85rem;
  }
}

/* ========== UTILITY CLASSES ========== */
.text-center {
  text-align: center !important;
}

.mt-3 {
  margin-top: 1rem !important;
}

.mb-3 {
  margin-bottom: 1rem !important;
}

/* ========== NO ORDERS MESSAGE ========== */
p:empty,
p:contains("No orders found") {
  text-align: center;
  padding: 3rem;
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(139, 69, 19, 0.08);
  color: var(--dark-brown);
  font-size: 1.2rem;
  font-weight: 500;
  border: 1px solid var(--light-brown);
  margin: 2rem 0;
}

/* ========== CUSTOM SCROLLBAR ========== */
.table-responsive-wrapper::-webkit-scrollbar {
  height: 8px;
}

.table-responsive-wrapper::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb {
  background: var(--light-brown);
  border-radius: 4px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb:hover {
  background: var(--medium-brown);
}

/* Fix for pagination scrollbar */
.pagination::-webkit-scrollbar {
  height: 6px;
}

.pagination::-webkit-scrollbar-track {
  background: rgba(139, 69, 19, 0.05);
  border-radius: 3px;
}

.pagination::-webkit-scrollbar-thumb {
  background: var(--light-brown);
  border-radius: 3px;
}
</style>

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
</head>
<body>
<div class="container mt-4">
  <h2 class="mb-4">Order Management</h2>

  <% if (!orders.length) { %>
    <p>No orders found.</p>
  <% } else { %>
    <form action="/admin/orders" method="get" class="d-flex gap-2 mb-3">

  <input type="text" name="search" class="form-control"
         placeholder="Search Order ID / Email / Name"
         value="<%= search %>">

  <select name="status" class="form-select">
      <option value="">All Status</option>
      <option value="Pending" <%= status === "Pending" ? "selected" : "" %>>Pending</option>
      <option value="Shipped" <%= status === "Shipped" ? "selected" : "" %>>Shipped</option>
      <option value="Delivered" <%= status === "Delivered" ? "selected" : "" %>>Delivered</option>
      <option value="Cancelled" <%= status === "Cancelled" ? "selected" : "" %>>Cancelled</option>
  </select>

  <select name="sort" class="form-select">
      <option value="desc" <%= sort === "desc" ? "selected" : "" %>>Newest First</option>
      <option value="asc" <%= sort === "asc" ? "selected" : "" %>>Oldest First</option>
  </select>

  <button class="btn btn-primary">Apply</button>
  <a href="/admin/orders" class="btn btn-secondary">Clear</a>

</form>

<div class="table-responsive-wrapper">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
         
          <th>Order ID</th>
          <th>Date</th>
          <th>User</th>
          <th>Email</th>
          <th>Status</th>
          <th>Change Status</th>
          <th>Total</th>
          <th>Return Request</th>
          <th>Action</th>
        </tr>
     

      </thead>
<tbody>
  <% orders.forEach((o, index) => { %>
    <% const itemsWithReturn = o.orderedItems?.filter(i => i.returnRequested) || []; %>

    <tr>
      <td><%= index + 1 %></td>
      <td><%= o.orderId %></td>
      <td><%= new Date(o.createdOn).toLocaleString() %></td>
      <td><%= o.userId ? o.userId.name : 'Guest' %></td>
      <td><%= o.userId ? o.userId.email : '-' %></td>

      <!-- STATUS DISPLAY -->
      <td>
        <span class="status-badge status-<%= o.status.toLowerCase().replace(/\s+/g, '-') %>">
          <%= o.status %>
        </span>
      </td>

      <!-- CHANGE STATUS -->
     <td>
  <% if (o.status === "Returned" || o.status === "Return Rejected") { %>

      <!-- Lock status once return is processed -->
      <span class="text-muted fw-bold">No further status updates</span>

  <% } else { %>

      <form class="statusForm"
            action="/admin/orders/<%= o.orderId %>/status"
            method="POST"
            style="display:flex;gap:8px;align-items:center;">

        <select name="status" class="form-select" style="padding:4px 8px;border-radius:6px;">
          <option value="Pending" <%= o.status === 'Pending' ? 'selected' : '' %>>Pending</option>
          <option value="Processing" <%= o.status === 'Processing' ? 'selected' : '' %>>Processing</option>
          <option value="Shipped" <%= o.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
          <option value="Out for Delivery" <%= o.status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
          <option value="Delivered" <%= o.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
          <option value="Cancelled" <%= o.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
        </select>

        <button type="submit" class="btn btn-secondary btn-sm">Update</button>
      </form>

  <% } %>
</td>


      <td>₹<%= o.finalAmount %></td>

      <!-- RETURN REQUEST COLUMN (Display-only; no Approve/Reject here) -->
      <td>
        <% if (itemsWithReturn.length === 0) { %>
         
        <% } else { %>
          <% itemsWithReturn.forEach(item => { %>
            <div class="return-box mb-2" data-item="<%= item._id %>">
              <div class="return-header">
                <strong><%= item.product ? item.product.productName : "ProductRemoved" %></strong>
              </div>
              <div class="return-body">
                <small><strong>Reason:</strong> <%= item.returnReason %></small><br/>
                <small><strong>Qty:</strong> <%= item.quantity %> &nbsp; 
                       <strong>Requested:</strong> <%= new Date(item.returnRequestedAt || item.createdAt).toLocaleDateString() %></small>
              </div>
            </div>
          <% }) %>
        <% } %>
      </td>

      <!-- Manage Returns button (only place with Approve/Reject controls) -->
      <td>
        <% if (itemsWithReturn.length === 0) { %>
          <span class="text-muted small">NO ANY REQUEST</span>
        <% } else { %>
          <button 
            class="btn btn-outline-primary btn-sm manageReturnBtn"
            data-order="<%= o.orderId %>"
            data-items="<%= Buffer.from(JSON.stringify(itemsWithReturn)).toString('base64') %>">
            ↪ Manage Returns
          </button>
        <% } %>
      </td>

      <td>
        <a href="/admin/orders/<%= o.orderId %>" class="btn btn-sm btn-primary">View</a>
      </td>
    </tr>

    <!-- Hidden per-order return-details row used by JS -->
    <tr class="return-details-row" id="return-box-<%= o.orderId %>" style="display:none;">
      <td colspan="10">
        <div class="return-details-container border rounded p-3 bg-light"></div>
      </td>
    </tr>
  <% }) %>
</tbody>


    </table>
    </div>

    <nav>
  <ul class="pagination justify-content-center">

    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
        <a class="page-link"
           href="/admin/orders?page=<%= i %>&search=<%= search %>&status=<%= status %>&sort=<%= sort %>">
           <%= i %>
        </a>
      </li>
    <% } %>

  </ul>
</nav>
        

  <% } %>
 

</div>
<script>


document.addEventListener("DOMContentLoaded", () => {
  // Small helper for safe logging
  const log = (...args) => { try { console.log(...args); } catch(e){} };

  // ------------------------------
  // Helper: update order-row small summary after approve/reject
  // ------------------------------
  function updateMainRowAfterAction(orderId, itemId) {
    try {
      const manageBtn = document.querySelector(`[data-order="${orderId}"].manageReturnBtn`);
      if (!manageBtn) return;
      const row = manageBtn.closest("tr");
      if (!row) return;
      const summary = row.querySelector(`.return-box[data-item="${itemId}"]`);
      if (summary) summary.remove();
      const remaining = row.querySelectorAll(".return-box");
      if (remaining.length === 0) {
        const span = document.createElement("span");
        span.className = "text-muted small";
        span.textContent = "No Return Requests";
        manageBtn.replaceWith(span);
      }
    } catch (err) {
      console.error("updateMainRowAfterAction error:", err);
    }
  }

  // ------------------------------
  // Manage Return button: open details box
  // ------------------------------
  document.querySelectorAll(".manageReturnBtn").forEach(btn => {
    btn.addEventListener("click", function () {
      try {
        if (!this.dataset.items) {
          console.warn("manageReturnBtn clicked but no dataset.items present");
          return;
        }

        // decode base64 safely
        let items;
        try {
          items = JSON.parse(atob(this.dataset.items));
        } catch (err) {
          console.error("Failed to parse manageReturnBtn dataset.items:", err, this.dataset.items);
          return Swal.fire("Error", "Unable to open return details (invalid data).", "error");
        }

        const orderId = this.dataset.order;
        const row = document.getElementById(`return-box-${orderId}`);
        if (!row) {
          console.warn("No return-box row for order:", orderId);
          return;
        }

        const container = row.querySelector(".return-details-container");

        let html = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Return Requested Items</h5>
            <button class="btn btn-sm btn-secondary clearReturnView" data-order="${orderId}">
              Clear
            </button>
          </div>

          <table class="table table-bordered bg-white">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Size</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Reason</th>
                <th>Requested On</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        items.forEach(i => {
          html += `
            <tr>
              <td>${i.product?.productName || "Removed"}</td>
              <td>${i.size || "-"}</td>
              <td>${i.quantity}</td>
              <td>₹${i.price}</td>
              <td>₹${i.price * i.quantity}</td>
              <td>${i.returnReason || "-"}</td>
              <td>${new Date(i.returnRequestedAt || i.createdAt || Date.now()).toLocaleString()}</td>
              <td>
                <button class="btn btn-success btn-sm approveReturnBtn"
                  data-order="${orderId}"
                  data-item="${i._id}"
                  data-url="/admin/orders/${orderId}/approve-return">
                  Approve
                </button>

                <button class="btn btn-danger btn-sm rejectReturnBtn"
                  data-order="${orderId}"
                  data-item="${i._id}"
                  data-url="/admin/orders/${orderId}/reject-return">
                  Reject
                </button>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;

        container.innerHTML = html;
        row.style.display = "table-row";

        // attach action handlers
        attachReturnActionHandlers();

      } catch (err) {
        console.error("manageReturnBtn handler error:", err);
        Swal.fire("Error", "Something went wrong when opening return details.", "error");
      }
    });
  });


  // ------------------------------
  // attach handlers for approve/reject/clear
  // ------------------------------
  function attachReturnActionHandlers() {
    // Clear view
    document.querySelectorAll(".clearReturnView").forEach(btn => {
      btn.onclick = function () {
        const orderId = this.dataset.order;
        const row = document.getElementById(`return-box-${orderId}`);
        if (row) row.style.display = "none";
      };
    });

    // Approve
    document.querySelectorAll(".approveReturnBtn").forEach(btn => {
      btn.onclick = async function () {
        const { url, item, order } = this.dataset;
        try {
          const confirm = await Swal.fire({
            title: "Approve Return?",
            text: "Stock will be restored.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Approve"
          });
          if (!confirm.isConfirmed) return;

          this.disabled = true;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ itemId: item })
          });
          const data = await res.json();
          if (!data.success) {
            this.disabled = false;
            return Swal.fire("Error", data.message || "Server error", "error");
          }

          Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Return approved", timer: 1400, showConfirmButton: false });

          // Update UI
          updateMainRowAfterAction(order, item);

            // Replace buttons with label
    const cell = this.parentElement;
    cell.innerHTML = `<span class="text-success fw-bold">Approved</span">`;
        } catch (err) {
          console.error("approveReturn error:", err);
          this.disabled = false;
          Swal.fire("Error", "Failed to approve return", "error");
        }
      };
    });

    // Reject
    document.querySelectorAll(".rejectReturnBtn").forEach(btn => {
      btn.onclick = async function () {
        const { url, item, order } = this.dataset;
        try {
          const { value: reason } = await Swal.fire({
            title: "Reject Return",
            input: "text",
            inputPlaceholder: "Reason required",
            showCancelButton: true,
            inputValidator: v => (!v ? "Reason required!" : null)
          });
          if (!reason) return;

          this.disabled = true;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ itemId: item, adminReason: reason })
          });
          const data = await res.json();
          if (!data.success) {
            this.disabled = false;
            return Swal.fire("Error", data.message || "Server error", "error");
          }

          Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Return rejected", timer: 1400, showConfirmButton: false });

          updateMainRowAfterAction(order, item);
          const cell = this.parentElement;
    cell.innerHTML = `<span class="text-danger fw-bold">Rejected</span">`;
        } catch (err) {
          console.error("rejectReturn error:", err);
          this.disabled = false;
          Swal.fire("Error", "Failed to reject return", "error");
        }
      };
    });
  } // attachReturnActionHandlers


  // ------------------------------
  // refreshReturnDetails (AJAX)
  // ------------------------------
  async function refreshReturnDetails(orderId) {
    try {
      const res = await fetch(`/admin/orders/${orderId}?ajax=true`);
      const data = await res.json();

      const btn = document.querySelector(`[data-order="${orderId}"].manageReturnBtn`);

      if (!data.returnRequests || data.returnRequests.length === 0) {
        // hide opened row
        const row = document.getElementById(`return-box-${orderId}`);
        if (row) row.style.display = "none";

        // replace manage button with text
        if (btn) {
          const span = document.createElement("span");
          span.className = "text-muted small";
          span.textContent = "No Return Requests";
          btn.replaceWith(span);
        }
        return;
      }

      // update dataset with base64-encoded JSON
      if (btn) btn.dataset.items = btoa(JSON.stringify(data.returnRequests));

      // reopen updated box
      if (btn) btn.click();
    } catch (err) {
      console.error("refreshReturnDetails error:", err);
    }
  }

  // ------------------------------
  // STATUS UPDATE HANDLER (AJAX with toast)
  // ------------------------------
  document.querySelectorAll(".statusForm").forEach(form => {
    form.addEventListener("submit", async function (e) {
      e.preventDefault(); // critical: prevents normal navigation

      try {
        const status = form.status.value;
        const statusBadge = form.closest("tr").querySelector(".status-badge");

        if (status === "Cancelled") {
          const confirmCancel = await Swal.fire({
            title: "Cancel Order?",
            text: "This cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Cancel"
          });
          if (!confirmCancel.isConfirmed) return;
        }

        const response = await fetch(form.action, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });

        const data = await response.json();

        if (data.success) {
          // update badge UI
          statusBadge.innerText = status;
          statusBadge.className = `status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}`;

          Swal.fire({
            toast: true,
            position: "top-end",
            icon: "success",
            title: "Status updated",
            showConfirmButton: false,
            timer: 1400
          });
        } else {
          Swal.fire({
            toast: true,
            position: "top-end",
            icon: "error",
            title: data.message || "Failed to update status",
            showConfirmButton: false,
            timer: 1800
          });
        }
      } catch (err) {
        console.error("statusForm submit error:", err);
        Swal.fire("Error", "Unable to update status (see console).", "error");
      }
    });
  });

  // End of DOMContentLoaded wrapper
}); 



// Fix table column alignment
document.addEventListener('DOMContentLoaded', function() {
  function alignTableColumns() {
    const table = document.querySelector('.table');
    if (!table) return;
    
    const headerCells = table.querySelectorAll('thead th');
    const bodyRows = table.querySelectorAll('tbody tr');
    
    // Reset all widths
    headerCells.forEach(cell => {
      cell.style.width = '';
    });
    
    // Set consistent widths
    bodyRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      cells.forEach((cell, index) => {
        if (headerCells[index]) {
          const headerWidth = headerCells[index].offsetWidth;
          cell.style.minWidth = headerWidth + 'px';
        }
      });
    });
  }
  
  // Run on load and window resize
  alignTableColumns();
  window.addEventListener('resize', alignTableColumns);
  
  // Also run after sidebar toggle
  const sidebarToggle = document.getElementById('sidebarToggle');
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', function() {
      setTimeout(alignTableColumns, 300); // Wait for sidebar transition
    });
  }
});
</script>



</body>
</html>