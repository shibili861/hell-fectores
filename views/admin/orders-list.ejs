
<style>
    :root {
        --primary-brown: #8B4513;
        --dark-brown: #654321;
        --light-brown: #D2B48C;
        --cream: #F5F5DC;
        --light-cream: #FDF5E6;
        --accent-gold: #D4AF37;
        --text-dark: #3E2723;
        --text-light: #5D4037;
        --shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        --transition: all 0.3s ease;
        --border-radius: 8px;
    }
    
    body {
        background-color: #f9f7f3;
        color: var(--text-dark);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dashboard-header {
        background: white;
        color: var(--text-dark);
        padding: 25px 30px;
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary-brown);
    }
    
    .dashboard-header h2 {
        font-weight: 600;
        margin: 0;
        font-size: 28px;
        color: var(--primary-brown);
    }
    
    .dashboard-header p {
        color: var(--text-light);
        margin: 5px 0 0;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border-top: 3px solid var(--light-brown);
        transition: var(--transition);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(139, 69, 19, 0.15);
    }
    
    .stat-card h3 {
        font-size: 14px;
        color: var(--text-light);
        margin: 0 0 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-brown);
        margin: 0;
    }
    
    .table-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }
    
    .table-header {
        background: white;
        color: var(--text-dark);
        padding: 18px 25px;
        border-bottom: 1px solid #eae2d6;
    }
    
    .table-header h3 {
        margin: 0;
        font-weight: 600;
        font-size: 20px;
        color: var(--primary-brown);
    }
    
    .table-controls {
        display: flex;
        gap: 15px;
    }
    
    .table-controls select, .table-controls input {
        border: 1px solid var(--light-brown);
        border-radius: var(--border-radius);
        padding: 8px 12px;
        background: white;
        color: var(--text-dark);
    }
    
    .table {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    
    .table thead th {
        background-color: #f8f4ec;
        color: var(--text-dark);
        font-weight: 600;
        padding: 15px;
        border-bottom: 2px solid var(--light-brown);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 14px;
    }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .table tbody tr:hover {
        background-color: rgba(210, 180, 140, 0.08);
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-pending {
        background-color: #FFF3E0;
        color: #EF6C00;
    }
    
    .status-processing {
        background-color: #E3F2FD;
        color: #1565C0;
    }
    
    .status-shipped {
        background-color: #E8F5E9;
        color: #2E7D32;
    }
    
    .status-out-for-delivery {
        background-color: #F3E5F5;
        color: #7B1FA2;
    }
    
    .status-delivered {
        background-color: #E8F5E9;
        color: #2E7D32;
    }
    
    .status-cancelled {
        background-color: #FFEBEE;
        color: #C62828;
    }
    
    .btn-view {
        background-color: var(--primary-brown);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: var(--transition);
    }
    
    .btn-view:hover {
        background-color: var(--dark-brown);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(139, 69, 19, 0.2);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-light);
    }
    
    .empty-state i {
        font-size: 64px;
        color: var(--light-brown);
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .empty-state p {
        font-size: 16px;
        max-width: 500px;
        margin: 0 auto 20px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: #f8f4ec;
        border-top: 1px solid var(--light-brown);
    }
    
    .pagination-info {
        color: var(--text-light);
        font-size: 14px;
    }
    
    .pagination {
        margin: 0;
    }
    
    .page-link {
        color: var(--primary-brown);
        border: 1px solid var(--light-brown);
        padding: 8px 16px;
        border-radius: var(--border-radius);
    }
    
    .page-link:hover {
        background-color: var(--light-brown);
        color: white;
    }
    
    .page-item.active .page-link {
        background-color: var(--primary-brown);
        border-color: var(--primary-brown);
    }
    
    /* ------------------ SEARCH / FILTER BAR ------------------ */
    .filter-wrapper {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 22px;
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .filter-wrapper input,
    .filter-wrapper select {
        background: white;
        border: 1px solid var(--light-brown);
        border-radius: var(--border-radius);
        padding: 10px 14px;
        font-size: 15px;
        transition: var(--transition);
    }

    .filter-wrapper input:focus,
    .filter-wrapper select:focus {
        outline: none;
        border-color: var(--primary-brown);
        box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.1);
    }

    /* Search button */
    .btn-primary {
        background: var(--primary-brown);
        border: none;
        padding: 10px 18px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        transition: var(--transition);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--dark-brown);
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--primary-brown);
        padding: 10px 18px;
        border-radius: var(--border-radius);
    }
    
    .btn-secondary:hover {
        background: var(--primary-brown);
        color: white;
    }

    /* ------------------ DROPDOWN STATUS COLOR ------------------ */
    form select {
        border: 1px solid var(--light-brown);
        border-radius: var(--border-radius);
        padding: 6px 10px;
        font-size: 14px;
        transition: var(--transition);
    }
    
    form select:hover {
        border-color: var(--primary-brown);
    }

    /* ------------------ PREMIUM PAGINATION ------------------ */
    .pagination {
        display: flex;
        justify-content: center;
        padding: 18px;
        gap: 8px;
    }

    .pagination .page-item .page-link {
        background: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--light-brown);
        padding: 10px 18px;
        font-weight: 600;
        transition: var(--transition);
        color: var(--text-dark);
    }

    .pagination .page-item .page-link:hover {
        background: var(--primary-brown);
        color: white;
        transform: translateY(-2px);
    }

    /* ACTIVE PAGE */
    .pagination .page-item.active .page-link {
        background: var(--primary-brown);
        color: white;
        border-color: var(--primary-brown);
    }

    /* ------------------ TABLE HOVER + PREMIUM LOOK ------------------ */
    .table {
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .table tbody tr:hover {
        background: rgba(210, 180, 140, 0.08);
        transition: var(--transition);
    }

    .table thead th {
        background: #f8f4ec !important;
        color: var(--text-dark) !important;
        border: none;
    }

    /* ------------------ STATUS BADGES (already working) ------------------ */
    .status-badge {
        border-radius: 30px;
        padding: 6px 14px;
        font-weight: 600;
    }
    /* Returned */
.status-returned {
  background: #28a745;      /* green */
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: 600;
  display: inline-block;
}

/* Return Rejected */
.status-return-rejected {
  background: #dc3545;      /* red */
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: 600;
  display: inline-block;
}
.manageReturnBtn {
  border: 1px solid #0d6efd;      /* Bootstrap primary */
  color: #0d6efd;
  background: #ffffff;
  padding: 4px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: 600;
  transition: all 0.2s ease;
}

/* Hover */
.manageReturnBtn:hover {
  background: #0d6efd;
  color: #ffffff;
  border-color: #0d6efd;
  box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.15);
}

/* Active (when clicked) */
.manageReturnBtn:active {
  transform: scale(0.97);
}

/* Disabled state */
.manageReturnBtn:disabled {
  background: #e4e4e4 !important;
  color: #888 !important;
  border-color: #ccc !important;
  cursor: not-allowed;
}



    @media (max-width: 768px) {
        .table-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .table-controls {
            width: 100%;
            flex-wrap: wrap;
        }
        
        .stats-cards {
            grid-template-columns: 1fr;
        }
        
        .table-responsive {
            border: none;
        }
        
        .filter-wrapper {
            flex-direction: column;
        }
    }
    
</style>

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
     <%- include('../partials/admin/sidebar') %>
</head>
<body>
<div class="container mt-4">
  <h2 class="mb-4">Order Management</h2>

  <% if (!orders.length) { %>
    <p>No orders found.</p>
  <% } else { %>
    <form action="/admin/orders" method="get" class="d-flex gap-2 mb-3">

  <input type="text" name="search" class="form-control"
         placeholder="Search Order ID / Email / Name"
         value="<%= search %>">

  <select name="status" class="form-select">
      <option value="">All Status</option>
      <option value="Pending" <%= status === "Pending" ? "selected" : "" %>>Pending</option>
      <option value="Shipped" <%= status === "Shipped" ? "selected" : "" %>>Shipped</option>
      <option value="Delivered" <%= status === "Delivered" ? "selected" : "" %>>Delivered</option>
      <option value="Cancelled" <%= status === "Cancelled" ? "selected" : "" %>>Cancelled</option>
  </select>

  <select name="sort" class="form-select">
      <option value="desc" <%= sort === "desc" ? "selected" : "" %>>Newest First</option>
      <option value="asc" <%= sort === "asc" ? "selected" : "" %>>Oldest First</option>
  </select>

  <button class="btn btn-primary">Apply</button>
  <a href="/admin/orders" class="btn btn-secondary">Clear</a>

</form>


    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
         
          <th>Order ID</th>
          <th>Date</th>
          <th>User</th>
          <th>Email</th>
          <th>Status</th>
          <th>Change Status</th>
          <th>Total</th>
          <th>Return Request</th>
          <th>Action</th>
        </tr>
     

      </thead>
<tbody>
  <% orders.forEach((o, index) => { %>
    <% const itemsWithReturn = o.orderedItems?.filter(i => i.returnRequested) || []; %>

    <tr>
      <td><%= index + 1 %></td>
      <td><%= o.orderId %></td>
      <td><%= new Date(o.createdOn).toLocaleString() %></td>
      <td><%= o.userId ? o.userId.name : 'Guest' %></td>
      <td><%= o.userId ? o.userId.email : '-' %></td>

      <!-- STATUS DISPLAY -->
      <td>
        <span class="status-badge status-<%= o.status.toLowerCase().replace(/\s+/g, '-') %>">
          <%= o.status %>
        </span>
      </td>

      <!-- CHANGE STATUS -->
     <td>
  <% if (o.status === "Returned" || o.status === "Return Rejected") { %>

      <!-- Lock status once return is processed -->
      <span class="text-muted fw-bold">No further status updates</span>

  <% } else { %>

      <form class="statusForm"
            action="/admin/orders/<%= o.orderId %>/status"
            method="POST"
            style="display:flex;gap:8px;align-items:center;">

        <select name="status" class="form-select" style="padding:4px 8px;border-radius:6px;">
          <option value="Pending" <%= o.status === 'Pending' ? 'selected' : '' %>>Pending</option>
          <option value="Processing" <%= o.status === 'Processing' ? 'selected' : '' %>>Processing</option>
          <option value="Shipped" <%= o.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
          <option value="Out for Delivery" <%= o.status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
          <option value="Delivered" <%= o.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
          <option value="Cancelled" <%= o.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
        </select>

        <button type="submit" class="btn btn-secondary btn-sm">Update</button>
      </form>

  <% } %>
</td>


      <td>₹<%= o.finalAmount %></td>

      <!-- RETURN REQUEST COLUMN (Display-only; no Approve/Reject here) -->
      <td>
        <% if (itemsWithReturn.length === 0) { %>
         
        <% } else { %>
          <% itemsWithReturn.forEach(item => { %>
            <div class="return-box mb-2" data-item="<%= item._id %>">
              <div class="return-header">
                <strong><%= item.product ? item.product.productName : "ProductRemoved" %></strong>
              </div>
              <div class="return-body">
                <small><strong>Reason:</strong> <%= item.returnReason %></small><br/>
                <small><strong>Qty:</strong> <%= item.quantity %> &nbsp; 
                       <strong>Requested:</strong> <%= new Date(item.returnRequestedAt || item.createdAt).toLocaleDateString() %></small>
              </div>
            </div>
          <% }) %>
        <% } %>
      </td>

      <!-- Manage Returns button (only place with Approve/Reject controls) -->
      <td>
        <% if (itemsWithReturn.length === 0) { %>
          <span class="text-muted small">NO ANY REQUEST</span>
        <% } else { %>
          <button 
            class="btn btn-outline-primary btn-sm manageReturnBtn"
            data-order="<%= o.orderId %>"
            data-items="<%= Buffer.from(JSON.stringify(itemsWithReturn)).toString('base64') %>">
            ↪ Manage Returns
          </button>
        <% } %>
      </td>

      <td>
        <a href="/admin/orders/<%= o.orderId %>" class="btn btn-sm btn-primary">View</a>
      </td>
    </tr>

    <!-- Hidden per-order return-details row used by JS -->
    <tr class="return-details-row" id="return-box-<%= o.orderId %>" style="display:none;">
      <td colspan="10">
        <div class="return-details-container border rounded p-3 bg-light"></div>
      </td>
    </tr>
  <% }) %>
</tbody>


    </table>

    <nav>
  <ul class="pagination justify-content-center">

    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
        <a class="page-link"
           href="/admin/orders?page=<%= i %>&search=<%= search %>&status=<%= status %>&sort=<%= sort %>">
           <%= i %>
        </a>
      </li>
    <% } %>

  </ul>
</nav>
        

  <% } %>
 

</div>
<script>


document.addEventListener("DOMContentLoaded", () => {
  // Small helper for safe logging
  const log = (...args) => { try { console.log(...args); } catch(e){} };

  // ------------------------------
  // Helper: update order-row small summary after approve/reject
  // ------------------------------
  function updateMainRowAfterAction(orderId, itemId) {
    try {
      const manageBtn = document.querySelector(`[data-order="${orderId}"].manageReturnBtn`);
      if (!manageBtn) return;
      const row = manageBtn.closest("tr");
      if (!row) return;
      const summary = row.querySelector(`.return-box[data-item="${itemId}"]`);
      if (summary) summary.remove();
      const remaining = row.querySelectorAll(".return-box");
      if (remaining.length === 0) {
        const span = document.createElement("span");
        span.className = "text-muted small";
        span.textContent = "No Return Requests";
        manageBtn.replaceWith(span);
      }
    } catch (err) {
      console.error("updateMainRowAfterAction error:", err);
    }
  }

  // ------------------------------
  // Manage Return button: open details box
  // ------------------------------
  document.querySelectorAll(".manageReturnBtn").forEach(btn => {
    btn.addEventListener("click", function () {
      try {
        if (!this.dataset.items) {
          console.warn("manageReturnBtn clicked but no dataset.items present");
          return;
        }

        // decode base64 safely
        let items;
        try {
          items = JSON.parse(atob(this.dataset.items));
        } catch (err) {
          console.error("Failed to parse manageReturnBtn dataset.items:", err, this.dataset.items);
          return Swal.fire("Error", "Unable to open return details (invalid data).", "error");
        }

        const orderId = this.dataset.order;
        const row = document.getElementById(`return-box-${orderId}`);
        if (!row) {
          console.warn("No return-box row for order:", orderId);
          return;
        }

        const container = row.querySelector(".return-details-container");

        let html = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Return Requested Items</h5>
            <button class="btn btn-sm btn-secondary clearReturnView" data-order="${orderId}">
              Clear
            </button>
          </div>

          <table class="table table-bordered bg-white">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Size</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Reason</th>
                <th>Requested On</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        items.forEach(i => {
          html += `
            <tr>
              <td>${i.product?.productName || "Removed"}</td>
              <td>${i.size || "-"}</td>
              <td>${i.quantity}</td>
              <td>₹${i.price}</td>
              <td>₹${i.price * i.quantity}</td>
              <td>${i.returnReason || "-"}</td>
              <td>${new Date(i.returnRequestedAt || i.createdAt || Date.now()).toLocaleString()}</td>
              <td>
                <button class="btn btn-success btn-sm approveReturnBtn"
                  data-order="${orderId}"
                  data-item="${i._id}"
                  data-url="/admin/orders/${orderId}/approve-return">
                  Approve
                </button>

                <button class="btn btn-danger btn-sm rejectReturnBtn"
                  data-order="${orderId}"
                  data-item="${i._id}"
                  data-url="/admin/orders/${orderId}/reject-return">
                  Reject
                </button>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;

        container.innerHTML = html;
        row.style.display = "table-row";

        // attach action handlers
        attachReturnActionHandlers();

      } catch (err) {
        console.error("manageReturnBtn handler error:", err);
        Swal.fire("Error", "Something went wrong when opening return details.", "error");
      }
    });
  });


  // ------------------------------
  // attach handlers for approve/reject/clear
  // ------------------------------
  function attachReturnActionHandlers() {
    // Clear view
    document.querySelectorAll(".clearReturnView").forEach(btn => {
      btn.onclick = function () {
        const orderId = this.dataset.order;
        const row = document.getElementById(`return-box-${orderId}`);
        if (row) row.style.display = "none";
      };
    });

    // Approve
    document.querySelectorAll(".approveReturnBtn").forEach(btn => {
      btn.onclick = async function () {
        const { url, item, order } = this.dataset;
        try {
          const confirm = await Swal.fire({
            title: "Approve Return?",
            text: "Stock will be restored.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Approve"
          });
          if (!confirm.isConfirmed) return;

          this.disabled = true;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ itemId: item })
          });
          const data = await res.json();
          if (!data.success) {
            this.disabled = false;
            return Swal.fire("Error", data.message || "Server error", "error");
          }

          Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Return approved", timer: 1400, showConfirmButton: false });

          // Update UI
          updateMainRowAfterAction(order, item);

            // Replace buttons with label
    const cell = this.parentElement;
    cell.innerHTML = `<span class="text-success fw-bold">Approved</span">`;
        } catch (err) {
          console.error("approveReturn error:", err);
          this.disabled = false;
          Swal.fire("Error", "Failed to approve return", "error");
        }
      };
    });

    // Reject
    document.querySelectorAll(".rejectReturnBtn").forEach(btn => {
      btn.onclick = async function () {
        const { url, item, order } = this.dataset;
        try {
          const { value: reason } = await Swal.fire({
            title: "Reject Return",
            input: "text",
            inputPlaceholder: "Reason required",
            showCancelButton: true,
            inputValidator: v => (!v ? "Reason required!" : null)
          });
          if (!reason) return;

          this.disabled = true;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ itemId: item, adminReason: reason })
          });
          const data = await res.json();
          if (!data.success) {
            this.disabled = false;
            return Swal.fire("Error", data.message || "Server error", "error");
          }

          Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Return rejected", timer: 1400, showConfirmButton: false });

          updateMainRowAfterAction(order, item);
          const cell = this.parentElement;
    cell.innerHTML = `<span class="text-danger fw-bold">Rejected</span">`;
        } catch (err) {
          console.error("rejectReturn error:", err);
          this.disabled = false;
          Swal.fire("Error", "Failed to reject return", "error");
        }
      };
    });
  } // attachReturnActionHandlers


  // ------------------------------
  // refreshReturnDetails (AJAX)
  // ------------------------------
  async function refreshReturnDetails(orderId) {
    try {
      const res = await fetch(`/admin/orders/${orderId}?ajax=true`);
      const data = await res.json();

      const btn = document.querySelector(`[data-order="${orderId}"].manageReturnBtn`);

      if (!data.returnRequests || data.returnRequests.length === 0) {
        // hide opened row
        const row = document.getElementById(`return-box-${orderId}`);
        if (row) row.style.display = "none";

        // replace manage button with text
        if (btn) {
          const span = document.createElement("span");
          span.className = "text-muted small";
          span.textContent = "No Return Requests";
          btn.replaceWith(span);
        }
        return;
      }

      // update dataset with base64-encoded JSON
      if (btn) btn.dataset.items = btoa(JSON.stringify(data.returnRequests));

      // reopen updated box
      if (btn) btn.click();
    } catch (err) {
      console.error("refreshReturnDetails error:", err);
    }
  }

  // ------------------------------
  // STATUS UPDATE HANDLER (AJAX with toast)
  // ------------------------------
  document.querySelectorAll(".statusForm").forEach(form => {
    form.addEventListener("submit", async function (e) {
      e.preventDefault(); // critical: prevents normal navigation

      try {
        const status = form.status.value;
        const statusBadge = form.closest("tr").querySelector(".status-badge");

        if (status === "Cancelled") {
          const confirmCancel = await Swal.fire({
            title: "Cancel Order?",
            text: "This cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Cancel"
          });
          if (!confirmCancel.isConfirmed) return;
        }

        const response = await fetch(form.action, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });

        const data = await response.json();

        if (data.success) {
          // update badge UI
          statusBadge.innerText = status;
          statusBadge.className = `status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}`;

          Swal.fire({
            toast: true,
            position: "top-end",
            icon: "success",
            title: "Status updated",
            showConfirmButton: false,
            timer: 1400
          });
        } else {
          Swal.fire({
            toast: true,
            position: "top-end",
            icon: "error",
            title: data.message || "Failed to update status",
            showConfirmButton: false,
            timer: 1800
          });
        }
      } catch (err) {
        console.error("statusForm submit error:", err);
        Swal.fire("Error", "Unable to update status (see console).", "error");
      }
    });
  });

  // End of DOMContentLoaded wrapper
}); 
</script>



</body>
</html>